#!/usr/bin/env python3
"""
Full AI-Driven Penetration Test Example
========================================

This example demonstrates how to run a complete AI-driven penetration test
that follows the full methodology:

1. Reconnaissance - Discover targets and gather information
2. Enumeration - Deep dive into services
3. Vulnerability Assessment - Find security issues
4. Exploitation - Validate vulnerabilities
5. Reporting - Generate comprehensive report

The AI Brain analyzes each tool's output and makes decisions about next steps.
"""

import asyncio
import sys
from pathlib import Path

# Add parent to path for imports
sys.path.insert(0, str(Path(__file__).parent.parent))

from ai_pentest import PentestEngine, EngineConfig, run_pentest
from ai_pentest.engine import (
    AttackSurface,
    AIBrain,
    AttackPlanner,
    ReconnaissancePhase,
    VulnerabilityPhase,
)


async def simple_pentest():
    """
    Simplest way to run a penetration test.
    Uses the convenience function with sensible defaults.
    """
    print("=" * 60)
    print("Simple Pentest Example")
    print("=" * 60)
    
    # One-liner to run a pentest
    result = await run_pentest(
        target="example.com",
        output_dir="./simple_pentest_output",
        phases=["reconnaissance", "enumeration", "vulnerability", "reporting"],
        ai_enabled=True,
        auto_mode=True
    )
    
    print(f"\nPentest completed: {result.success}")
    print(f"Total findings: {result.total_findings}")
    print(f"Vulnerabilities: {result.total_vulnerabilities}")
    print(f"  Critical: {result.critical_count}")
    print(f"  High: {result.high_count}")


async def custom_pentest():
    """
    Custom penetration test with full configuration control.
    """
    print("=" * 60)
    print("Custom Pentest Example")
    print("=" * 60)
    
    # Create detailed configuration
    config = EngineConfig(
        target="testsite.example.com",
        scope=["api.example.com", "admin.example.com"],  # Additional in-scope
        out_of_scope=["cdn.example.com"],
        output_dir="./custom_pentest_output",
        
        # Select specific phases
        phases_to_run=[
            "reconnaissance",
            "enumeration",
            "vulnerability",
            "exploitation",
            "post_exploitation",
            "reporting"
        ],
        
        # AI configuration
        ai_enabled=True,
        api_key=None,  # Uses env var or falls back to offline analysis
        
        # Automation settings
        auto_mode=True,
        max_iterations_per_phase=5,  # Limit iterations per phase
        stop_on_critical=False,  # Continue even if critical found
        
        # Safety settings
        safe_mode=True,  # Avoid aggressive scans
        respect_rate_limits=True,
        max_concurrent_tools=3
    )
    
    # Create engine
    engine = PentestEngine(config)
    
    # Run the pentest
    try:
        result = await engine.run()
        
        # Access detailed results
        print("\n--- Phase Results ---")
        for phase_name, phase_result in result.phase_results.items():
            print(f"\n{phase_name.upper()}:")
            print(f"  Duration: {phase_result.duration:.1f}s")
            print(f"  Tools Run: {phase_result.tools_run}")
            print(f"  Findings: {phase_result.findings_count}")
            print(f"  New Vulns: {phase_result.new_vulnerabilities}")
        
        # Show attack plan if generated
        if result.attack_plan:
            print("\n--- Attack Plan ---")
            print(f"Recommended Path: {result.attack_plan.recommended_path}")
            print(f"Total Paths: {len(result.attack_plan.paths)}")
        
        return result
        
    except Exception as e:
        print(f"Error: {e}")
        raise


async def run_single_phase():
    """
    Run just a single phase of the pentest.
    Useful for targeted testing or resuming an interrupted pentest.
    """
    print("=" * 60)
    print("Single Phase Example")
    print("=" * 60)
    
    config = EngineConfig(
        target="example.com",
        output_dir="./phase_output"
    )
    
    engine = PentestEngine(config)
    
    # Run just reconnaissance
    result = await engine.run_phase("reconnaissance")
    
    print(f"\nReconnaissance completed")
    print(f"  Duration: {result.duration:.1f}s")
    print(f"  Tools: {result.tools_run}")
    print(f"  Findings: {result.findings_count}")
    
    # Can access the attack surface directly
    print(f"\nAttack Surface:")
    print(f"  Assets: {len(engine.attack_surface.assets)}")
    print(f"  Subdomains: {len(engine.attack_surface.subdomains)}")


async def custom_attack_planning():
    """
    Use the AI brain and attack planner independently
    for custom attack planning scenarios.
    """
    print("=" * 60)
    print("Custom Attack Planning Example")
    print("=" * 60)
    
    # Create attack surface manually
    attack_surface = AttackSurface("example.com")
    
    # Add some mock data
    from ai_pentest.engine.attack_surface import (
        Asset, AssetType, Service, ServiceType,
        Vulnerability, VulnSeverity, Credential
    )
    
    # Add a web server
    web_asset = Asset(
        id="web-1",
        name="www.example.com",
        asset_type=AssetType.WEB_APPLICATION,
        hostnames=["www.example.com"],
        ip_addresses=["93.184.216.34"],
        services=[
            Service(port=80, service_type=ServiceType.HTTP),
            Service(port=443, service_type=ServiceType.HTTPS),
        ]
    )
    attack_surface.add_asset(web_asset)
    
    # Add a vulnerability
    vuln = Vulnerability(
        id="VULN-001",
        title="SQL Injection in login form",
        severity=VulnSeverity.CRITICAL,
        description="The login form is vulnerable to SQL injection",
        affected_asset="www.example.com/login",
        exploitable=True
    )
    attack_surface.add_vulnerability(vuln)
    
    # Add a credential
    cred = Credential(
        username="admin",
        password="",
        hash="5f4dcc3b5aa765d61d8327deb882cf99",
        hash_type="MD5",
        source="database dump"
    )
    attack_surface.add_credential(cred)
    
    # Create AI brain and planner
    ai_brain = AIBrain()
    planner = AttackPlanner(ai_brain)
    
    try:
        # Generate attack plan
        plan = await planner.generate_plan(
            attack_surface,
            objectives=["gain database access", "demonstrate data exfiltration"]
        )
        
        # Display plan
        planner.display_plan(plan)
        
        # Can also get AI decisions
        await ai_brain.initialize()
        decisions = await ai_brain.decide_next_steps(
            attack_surface=attack_surface,
            current_phase="exploitation"
        )
        
        print("\n--- AI Recommendations ---")
        for d in decisions:
            print(f"[Priority: {d.priority}] {d.decision_type.value}")
            print(f"  Tool: {d.tool}")
            print(f"  Target: {d.target}")
            print(f"  Reason: {d.reasoning}")
        
    finally:
        await ai_brain.close()


async def monitor_progress():
    """
    Monitor pentest progress in real-time.
    """
    print("=" * 60)
    print("Progress Monitoring Example")
    print("=" * 60)
    
    config = EngineConfig(
        target="example.com",
        output_dir="./monitored_output"
    )
    
    engine = PentestEngine(config)
    
    # Start pentest in background
    async def run_in_background():
        return await engine.run()
    
    task = asyncio.create_task(run_in_background())
    
    # Monitor progress
    while not task.done():
        status = engine.get_status()
        print(f"\rPhase: {status['current_phase'] or 'starting'} | "
              f"Assets: {status['assets_discovered']} | "
              f"Vulns: {status['vulnerabilities_found']} | "
              f"Time: {status['duration_so_far']:.0f}s", end="")
        await asyncio.sleep(2)
    
    print("\n\nPentest completed!")
    result = await task
    print(f"Success: {result.success}")


async def main():
    """Main entry point for examples"""
    import sys
    
    examples = {
        "simple": simple_pentest,
        "custom": custom_pentest,
        "phase": run_single_phase,
        "plan": custom_attack_planning,
        "monitor": monitor_progress
    }
    
    if len(sys.argv) > 1:
        example_name = sys.argv[1]
        if example_name in examples:
            await examples[example_name]()
        else:
            print(f"Unknown example: {example_name}")
            print(f"Available: {', '.join(examples.keys())}")
    else:
        print("AI Pentest Engine Examples")
        print("-" * 40)
        print("Usage: python full_pentest.py <example>")
        print("\nAvailable examples:")
        print("  simple  - Simplest way to run a pentest")
        print("  custom  - Full custom configuration")
        print("  phase   - Run a single phase")
        print("  plan    - Attack planning only")
        print("  monitor - Real-time progress monitoring")
        print("\nExample: python full_pentest.py simple")


if __name__ == "__main__":
    asyncio.run(main())
