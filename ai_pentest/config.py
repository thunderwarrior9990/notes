"""
Configuration management for AI Pentest Tool
"""

import os
from pathlib import Path
from typing import Optional, Dict, Any, List
from functools import lru_cache

import yaml
from pydantic import Field, field_validator
from pydantic_settings import BaseSettings


class CursorSettings(BaseSettings):
    """Cursor API configuration"""
    api_key: str = Field(default="", description="Cursor API key")
    base_url: str = Field(default="https://api.cursor.com/v1", description="Cursor API base URL")
    model: str = Field(default="claude-3-5-sonnet-20241022", description="Model to use")
    max_tokens: int = Field(default=4096, description="Max tokens for response")
    temperature: float = Field(default=0.3, description="Temperature for responses")

    class Config:
        env_prefix = "CURSOR_"


class AnthropicSettings(BaseSettings):
    """Direct Anthropic API configuration (fallback)"""
    api_key: str = Field(default="", description="Anthropic API key")
    base_url: str = Field(default="https://api.anthropic.com/v1", description="Anthropic API base URL")
    model: str = Field(default="claude-3-5-sonnet-20241022", description="Model to use")
    max_tokens: int = Field(default=4096, description="Max tokens for response")

    class Config:
        env_prefix = "ANTHROPIC_"


class NetworkScanSettings(BaseSettings):
    """Network scanning configuration"""
    timeout: int = Field(default=30, description="Timeout in seconds")
    max_concurrent: int = Field(default=50, description="Max concurrent connections")
    quick_ports: str = Field(
        default="21,22,23,25,53,80,110,143,443,445,993,995,3306,3389,5432,8080,8443",
        description="Quick scan port list"
    )
    common_ports: str = Field(default="1-1024", description="Common port range")
    full_ports: str = Field(default="1-65535", description="Full port range")


class WebScanSettings(BaseSettings):
    """Web scanning configuration"""
    timeout: int = Field(default=30, description="Request timeout")
    max_concurrent: int = Field(default=20, description="Max concurrent requests")
    user_agent: str = Field(
        default="AI-Pentest/1.0 (Security Assessment Tool)",
        description="User agent string"
    )
    follow_redirects: bool = Field(default=True, description="Follow HTTP redirects")
    max_redirects: int = Field(default=5, description="Maximum redirects to follow")


class SubdomainSettings(BaseSettings):
    """Subdomain enumeration configuration"""
    timeout: int = Field(default=10, description="DNS resolution timeout")
    max_concurrent: int = Field(default=100, description="Max concurrent DNS queries")
    wordlist: str = Field(default="default", description="Wordlist to use")
    dns_resolvers: List[str] = Field(
        default=["8.8.8.8", "1.1.1.1", "9.9.9.9"],
        description="DNS resolvers to use"
    )


class SSLSettings(BaseSettings):
    """SSL/TLS analysis configuration"""
    timeout: int = Field(default=15, description="SSL connection timeout")
    check_cert_chain: bool = Field(default=True, description="Check certificate chain")
    check_vulnerabilities: bool = Field(default=True, description="Check for known vulnerabilities")


class ReportSettings(BaseSettings):
    """Report generation configuration"""
    output_dir: str = Field(default="./reports", description="Output directory")
    format: str = Field(default="html", description="Report format (html, pdf, markdown)")
    include_evidence: bool = Field(default=True, description="Include evidence screenshots")
    include_recommendations: bool = Field(default=True, description="Include remediation recommendations")
    severity_colors: Dict[str, str] = Field(
        default={
            "critical": "#dc3545",
            "high": "#fd7e14",
            "medium": "#ffc107",
            "low": "#28a745",
            "info": "#17a2b8"
        },
        description="Severity level colors"
    )


class SafetySettings(BaseSettings):
    """Safety configuration"""
    requests_per_second: int = Field(default=10, description="Rate limit")
    respect_robots_txt: bool = Field(default=True, description="Respect robots.txt")
    max_crawl_depth: int = Field(default=3, description="Maximum crawl depth")
    request_timeout: int = Field(default=30, description="Request timeout")
    excluded_paths: List[str] = Field(
        default=["/logout", "/signout", "/delete", "/remove"],
        description="Paths to exclude from scanning"
    )


class Settings(BaseSettings):
    """Main settings class"""
    cursor: CursorSettings = Field(default_factory=CursorSettings)
    anthropic: AnthropicSettings = Field(default_factory=AnthropicSettings)
    network: NetworkScanSettings = Field(default_factory=NetworkScanSettings)
    web: WebScanSettings = Field(default_factory=WebScanSettings)
    subdomain: SubdomainSettings = Field(default_factory=SubdomainSettings)
    ssl: SSLSettings = Field(default_factory=SSLSettings)
    report: ReportSettings = Field(default_factory=ReportSettings)
    safety: SafetySettings = Field(default_factory=SafetySettings)
    
    # Logging
    log_level: str = Field(default="INFO", description="Logging level")
    log_file: str = Field(default="ai_pentest.log", description="Log file path")

    class Config:
        env_prefix = "AIPENTEST_"
        env_nested_delimiter = "__"

    @classmethod
    def from_yaml(cls, config_path: str = "config.yaml") -> "Settings":
        """Load settings from YAML file"""
        config_file = Path(config_path)
        
        if config_file.exists():
            with open(config_file, "r") as f:
                config_data = yaml.safe_load(f) or {}
                
            # Expand environment variables
            config_data = cls._expand_env_vars(config_data)
            
            # Process network config to flatten port_ranges
            network_config = config_data.get("scanning", {}).get("network", {})
            network_config = cls._flatten_network_config(network_config)
            
            # Map YAML structure to settings
            return cls(
                cursor=CursorSettings(**config_data.get("cursor", {})),
                anthropic=AnthropicSettings(**config_data.get("anthropic", {})),
                network=NetworkScanSettings(**network_config),
                web=WebScanSettings(**config_data.get("scanning", {}).get("web", {})),
                subdomain=SubdomainSettings(**config_data.get("scanning", {}).get("subdomain", {})),
                ssl=SSLSettings(**config_data.get("scanning", {}).get("ssl", {})),
                report=ReportSettings(**config_data.get("report", {})),
                safety=SafetySettings(**config_data.get("safety", {})),
                log_level=config_data.get("logging", {}).get("level", "INFO"),
                log_file=config_data.get("logging", {}).get("file", "ai_pentest.log"),
            )
        
        return cls()

    @classmethod
    def _flatten_network_config(cls, network_config: Dict[str, Any]) -> Dict[str, Any]:
        """Flatten nested port_ranges structure to flat fields"""
        result = dict(network_config)
        
        # Extract and flatten port_ranges if present
        if "port_ranges" in result:
            port_ranges = result.pop("port_ranges")
            if isinstance(port_ranges, dict):
                if "quick" in port_ranges:
                    result["quick_ports"] = port_ranges["quick"]
                if "common" in port_ranges:
                    result["common_ports"] = port_ranges["common"]
                if "full" in port_ranges:
                    result["full_ports"] = port_ranges["full"]
        
        return result

    @classmethod
    def _expand_env_vars(cls, data: Any) -> Any:
        """Recursively expand environment variables in config"""
        if isinstance(data, dict):
            return {k: cls._expand_env_vars(v) for k, v in data.items()}
        elif isinstance(data, list):
            return [cls._expand_env_vars(item) for item in data]
        elif isinstance(data, str):
            if data.startswith("${") and data.endswith("}"):
                env_var = data[2:-1]
                return os.environ.get(env_var, "")
            return data
        return data


@lru_cache()
def get_settings() -> Settings:
    """Get cached settings instance"""
    return Settings.from_yaml()
