"""
Report Generator
================

Generate professional HTML and PDF penetration testing reports.
"""

import os
import json
from pathlib import Path
from typing import Dict, List, Any, Optional
from datetime import datetime
from dataclasses import dataclass, field

from jinja2 import Environment, FileSystemLoader, select_autoescape
from rich.console import Console

from ..config import get_settings
from ..ai.cursor_client import CursorAIClient


console = Console()


@dataclass
class Finding:
    """Represents a security finding"""
    id: str
    title: str
    severity: str
    category: str
    description: str
    impact: str
    remediation: str
    evidence: str = ""
    url: str = ""
    parameter: str = ""
    cwe_id: str = ""
    cvss_score: float = 0.0
    status: str = "open"
    
    def to_dict(self) -> Dict[str, Any]:
        return {
            "id": self.id,
            "title": self.title,
            "severity": self.severity,
            "category": self.category,
            "description": self.description,
            "impact": self.impact,
            "remediation": self.remediation,
            "evidence": self.evidence,
            "url": self.url,
            "parameter": self.parameter,
            "cwe_id": self.cwe_id,
            "cvss_score": self.cvss_score,
            "status": self.status,
        }


@dataclass
class PentestReport:
    """Complete penetration test report"""
    title: str
    target: str
    findings: List[Finding] = field(default_factory=list)
    executive_summary: str = ""
    methodology: str = ""
    scope: str = ""
    timeline: str = ""
    recommendations: str = ""
    conclusion: str = ""
    assessor: str = "AI Pentest Tool"
    client: str = ""
    start_date: Optional[datetime] = None
    end_date: Optional[datetime] = None
    report_date: datetime = field(default_factory=datetime.now)
    network_findings: Dict[str, Any] = field(default_factory=dict)
    web_findings: Dict[str, Any] = field(default_factory=dict)
    ssl_findings: Dict[str, Any] = field(default_factory=dict)
    subdomain_findings: Dict[str, Any] = field(default_factory=dict)
    
    def get_summary(self) -> Dict[str, int]:
        """Get findings summary by severity"""
        summary = {"critical": 0, "high": 0, "medium": 0, "low": 0, "info": 0}
        for finding in self.findings:
            severity = finding.severity.lower()
            if severity in summary:
                summary[severity] += 1
        return summary
    
    def to_dict(self) -> Dict[str, Any]:
        return {
            "title": self.title,
            "target": self.target,
            "findings": [f.to_dict() for f in self.findings],
            "executive_summary": self.executive_summary,
            "methodology": self.methodology,
            "scope": self.scope,
            "timeline": self.timeline,
            "recommendations": self.recommendations,
            "conclusion": self.conclusion,
            "assessor": self.assessor,
            "client": self.client,
            "start_date": self.start_date.isoformat() if self.start_date else None,
            "end_date": self.end_date.isoformat() if self.end_date else None,
            "report_date": self.report_date.isoformat(),
            "summary": self.get_summary(),
            "network_findings": self.network_findings,
            "web_findings": self.web_findings,
            "ssl_findings": self.ssl_findings,
            "subdomain_findings": self.subdomain_findings,
        }


class ReportGenerator:
    """
    Generate professional penetration testing reports
    
    Features:
    - HTML report generation
    - PDF export (via WeasyPrint)
    - AI-enhanced content generation
    - Multiple templates
    - Custom styling
    """
    
    def __init__(self, output_dir: Optional[str] = None):
        self.settings = get_settings()
        self.output_dir = Path(output_dir or self.settings.report.output_dir)
        self.output_dir.mkdir(parents=True, exist_ok=True)
        
        # Setup Jinja2 environment
        template_dir = Path(__file__).parent / "templates"
        template_dir.mkdir(exist_ok=True)
        
        self.env = Environment(
            loader=FileSystemLoader(str(template_dir)),
            autoescape=select_autoescape(["html", "xml"])
        )
        
        # Create default template if not exists
        self._ensure_templates()
    
    def _ensure_templates(self):
        """Ensure report templates exist"""
        template_dir = Path(__file__).parent / "templates"
        
        # Main report template
        report_template = template_dir / "report.html"
        if not report_template.exists():
            report_template.write_text(self._get_default_template())
        
        # Styles
        styles_file = template_dir / "styles.css"
        if not styles_file.exists():
            styles_file.write_text(self._get_default_styles())
    
    def _get_default_template(self) -> str:
        """Get default HTML report template"""
        return '''<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ report.title }}</title>
    <style>
        {{ styles }}
    </style>
</head>
<body>
    <div class="report-container">
        <!-- Header -->
        <header class="report-header">
            <div class="logo">
                <h1>ðŸ”’ AI Pentest</h1>
            </div>
            <div class="report-meta">
                <h2>{{ report.title }}</h2>
                <p class="target">Target: {{ report.target }}</p>
                <p class="date">Report Date: {{ report.report_date.strftime('%B %d, %Y') }}</p>
            </div>
        </header>

        <!-- Summary Box -->
        <section class="summary-section">
            <h2>Findings Summary</h2>
            <div class="severity-grid">
                <div class="severity-card critical">
                    <span class="count">{{ summary.critical }}</span>
                    <span class="label">Critical</span>
                </div>
                <div class="severity-card high">
                    <span class="count">{{ summary.high }}</span>
                    <span class="label">High</span>
                </div>
                <div class="severity-card medium">
                    <span class="count">{{ summary.medium }}</span>
                    <span class="label">Medium</span>
                </div>
                <div class="severity-card low">
                    <span class="count">{{ summary.low }}</span>
                    <span class="label">Low</span>
                </div>
                <div class="severity-card info">
                    <span class="count">{{ summary.info }}</span>
                    <span class="label">Info</span>
                </div>
            </div>
        </section>

        <!-- Executive Summary -->
        <section class="executive-summary">
            <h2>Executive Summary</h2>
            <div class="content">
                {{ report.executive_summary | safe }}
            </div>
        </section>

        <!-- Scope -->
        {% if report.scope %}
        <section class="scope-section">
            <h2>Scope</h2>
            <div class="content">
                {{ report.scope | safe }}
            </div>
        </section>
        {% endif %}

        <!-- Methodology -->
        {% if report.methodology %}
        <section class="methodology-section">
            <h2>Methodology</h2>
            <div class="content">
                {{ report.methodology | safe }}
            </div>
        </section>
        {% endif %}

        <!-- Findings -->
        <section class="findings-section">
            <h2>Detailed Findings</h2>
            
            {% for finding in report.findings | sort(attribute='severity', reverse=true) %}
            <div class="finding-card severity-{{ finding.severity }}">
                <div class="finding-header">
                    <span class="finding-id">{{ finding.id }}</span>
                    <h3>{{ finding.title }}</h3>
                    <span class="severity-badge {{ finding.severity }}">{{ finding.severity | upper }}</span>
                </div>
                
                <div class="finding-meta">
                    {% if finding.category %}
                    <span class="category">{{ finding.category }}</span>
                    {% endif %}
                    {% if finding.cwe_id %}
                    <span class="cwe">{{ finding.cwe_id }}</span>
                    {% endif %}
                    {% if finding.cvss_score > 0 %}
                    <span class="cvss">CVSS: {{ finding.cvss_score }}</span>
                    {% endif %}
                </div>
                
                {% if finding.url %}
                <div class="finding-url">
                    <strong>Affected URL:</strong> {{ finding.url }}
                    {% if finding.parameter %}
                    <br><strong>Parameter:</strong> {{ finding.parameter }}
                    {% endif %}
                </div>
                {% endif %}
                
                <div class="finding-body">
                    <div class="section">
                        <h4>Description</h4>
                        <p>{{ finding.description }}</p>
                    </div>
                    
                    {% if finding.impact %}
                    <div class="section">
                        <h4>Impact</h4>
                        <p>{{ finding.impact }}</p>
                    </div>
                    {% endif %}
                    
                    {% if finding.evidence %}
                    <div class="section">
                        <h4>Evidence</h4>
                        <pre class="evidence">{{ finding.evidence }}</pre>
                    </div>
                    {% endif %}
                    
                    <div class="section">
                        <h4>Remediation</h4>
                        <p>{{ finding.remediation }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </section>

        <!-- Recommendations -->
        {% if report.recommendations %}
        <section class="recommendations-section">
            <h2>Recommendations</h2>
            <div class="content">
                {{ report.recommendations | safe }}
            </div>
        </section>
        {% endif %}

        <!-- Conclusion -->
        {% if report.conclusion %}
        <section class="conclusion-section">
            <h2>Conclusion</h2>
            <div class="content">
                {{ report.conclusion | safe }}
            </div>
        </section>
        {% endif %}

        <!-- Footer -->
        <footer class="report-footer">
            <p>Generated by AI Pentest Tool</p>
            <p>{{ report.report_date.strftime('%Y-%m-%d %H:%M:%S') }}</p>
        </footer>
    </div>
</body>
</html>'''
    
    def _get_default_styles(self) -> str:
        """Get default CSS styles"""
        return '''
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
    color: #333;
    background: #f5f5f5;
}

.report-container {
    max-width: 1200px;
    margin: 0 auto;
    background: white;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
}

.report-header {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: white;
    padding: 40px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.report-header .logo h1 {
    font-size: 2rem;
    font-weight: 700;
}

.report-meta h2 {
    font-size: 1.5rem;
    margin-bottom: 10px;
}

.report-meta p {
    opacity: 0.9;
    font-size: 0.95rem;
}

section {
    padding: 40px;
    border-bottom: 1px solid #eee;
}

section h2 {
    color: #1a1a2e;
    margin-bottom: 20px;
    font-size: 1.5rem;
    border-left: 4px solid #e94560;
    padding-left: 15px;
}

.summary-section {
    background: #fafafa;
}

.severity-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 20px;
    margin-top: 20px;
}

.severity-card {
    text-align: center;
    padding: 25px;
    border-radius: 10px;
    color: white;
}

.severity-card .count {
    font-size: 2.5rem;
    font-weight: 700;
    display: block;
}

.severity-card .label {
    font-size: 0.9rem;
    text-transform: uppercase;
    opacity: 0.9;
}

.severity-card.critical { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
.severity-card.high { background: linear-gradient(135deg, #fd7e14 0%, #e96b00 100%); }
.severity-card.medium { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #333; }
.severity-card.low { background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); }
.severity-card.info { background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%); }

.executive-summary .content,
.scope-section .content,
.methodology-section .content,
.recommendations-section .content,
.conclusion-section .content {
    background: #f8f9fa;
    padding: 25px;
    border-radius: 8px;
    border-left: 4px solid #16213e;
}

.finding-card {
    background: white;
    border-radius: 10px;
    margin-bottom: 25px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    overflow: hidden;
}

.finding-header {
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    border-bottom: 1px solid #eee;
}

.finding-id {
    background: #16213e;
    color: white;
    padding: 5px 12px;
    border-radius: 5px;
    font-size: 0.85rem;
    font-weight: 600;
}

.finding-header h3 {
    flex: 1;
    font-size: 1.1rem;
    color: #333;
}

.severity-badge {
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.severity-badge.critical { background: #dc3545; color: white; }
.severity-badge.high { background: #fd7e14; color: white; }
.severity-badge.medium { background: #ffc107; color: #333; }
.severity-badge.low { background: #28a745; color: white; }
.severity-badge.info { background: #17a2b8; color: white; }

.finding-card.severity-critical { border-left: 5px solid #dc3545; }
.finding-card.severity-high { border-left: 5px solid #fd7e14; }
.finding-card.severity-medium { border-left: 5px solid #ffc107; }
.finding-card.severity-low { border-left: 5px solid #28a745; }
.finding-card.severity-info { border-left: 5px solid #17a2b8; }

.finding-meta {
    padding: 10px 20px;
    background: #f8f9fa;
    display: flex;
    gap: 15px;
    font-size: 0.85rem;
}

.finding-meta span {
    padding: 3px 10px;
    background: white;
    border-radius: 15px;
    border: 1px solid #ddd;
}

.finding-url {
    padding: 15px 20px;
    background: #f8f9fa;
    font-family: monospace;
    font-size: 0.9rem;
    color: #666;
    word-break: break-all;
}

.finding-body {
    padding: 20px;
}

.finding-body .section {
    margin-bottom: 20px;
}

.finding-body .section:last-child {
    margin-bottom: 0;
}

.finding-body h4 {
    color: #16213e;
    font-size: 0.95rem;
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.finding-body p {
    color: #555;
}

.evidence {
    background: #1a1a2e;
    color: #0f0;
    padding: 15px;
    border-radius: 5px;
    overflow-x: auto;
    font-size: 0.85rem;
    white-space: pre-wrap;
    word-break: break-all;
}

.report-footer {
    background: #1a1a2e;
    color: white;
    padding: 20px 40px;
    text-align: center;
    font-size: 0.9rem;
    opacity: 0.9;
}

@media print {
    body { background: white; }
    .report-container { box-shadow: none; }
    .finding-card { break-inside: avoid; }
    section { break-inside: avoid; }
}

@media (max-width: 768px) {
    .severity-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    .report-header {
        flex-direction: column;
        text-align: center;
    }
}
'''
    
    async def generate(
        self,
        report: PentestReport,
        format: str = "html",
        use_ai: bool = True
    ) -> str:
        """
        Generate pentest report
        
        Args:
            report: PentestReport object with findings
            format: Output format (html, pdf, json)
            use_ai: Use AI for content enhancement
            
        Returns:
            Path to generated report
        """
        console.print(f"\n[bold cyan]Generating {format.upper()} Report...[/bold cyan]")
        
        # Enhance content with AI if enabled
        if use_ai:
            report = await self._enhance_with_ai(report)
        
        # Generate output based on format
        if format == "html":
            output_path = await self._generate_html(report)
        elif format == "pdf":
            output_path = await self._generate_pdf(report)
        elif format == "json":
            output_path = await self._generate_json(report)
        else:
            output_path = await self._generate_html(report)
        
        console.print(f"[green]âœ“[/green] Report saved to: {output_path}")
        
        return str(output_path)
    
    async def _enhance_with_ai(self, report: PentestReport) -> PentestReport:
        """Enhance report content using AI"""
        console.print("[cyan]Enhancing report with AI...[/cyan]")
        
        async with CursorAIClient() as ai:
            # Generate executive summary if not provided
            if not report.executive_summary:
                console.print("  [dim]Generating executive summary...[/dim]")
                response = await ai.generate_report_section(
                    section="executive_summary",
                    findings=[f.to_dict() for f in report.findings],
                    target_info={"target": report.target}
                )
                report.executive_summary = self._markdown_to_html(response.content)
            
            # Generate recommendations if not provided
            if not report.recommendations and report.findings:
                console.print("  [dim]Generating recommendations...[/dim]")
                response = await ai.generate_report_section(
                    section="recommendations",
                    findings=[f.to_dict() for f in report.findings],
                    target_info={"target": report.target}
                )
                report.recommendations = self._markdown_to_html(response.content)
            
            # Generate methodology if not provided
            if not report.methodology:
                console.print("  [dim]Generating methodology...[/dim]")
                response = await ai.generate_report_section(
                    section="methodology",
                    findings=[f.to_dict() for f in report.findings],
                    target_info={"target": report.target}
                )
                report.methodology = self._markdown_to_html(response.content)
        
        return report
    
    def _markdown_to_html(self, text: str) -> str:
        """Convert markdown to HTML"""
        try:
            import markdown
            return markdown.markdown(
                text,
                extensions=['tables', 'fenced_code', 'nl2br']
            )
        except ImportError:
            # Simple conversion without markdown library
            text = text.replace("\n\n", "</p><p>")
            text = text.replace("\n", "<br>")
            return f"<p>{text}</p>"
    
    async def _generate_html(self, report: PentestReport) -> Path:
        """Generate HTML report"""
        # Load template
        try:
            template = self.env.get_template("report.html")
        except Exception:
            # Use inline template if file not found
            from jinja2 import Template
            template = Template(self._get_default_template())
        
        # Load styles
        styles_path = Path(__file__).parent / "templates" / "styles.css"
        if styles_path.exists():
            styles = styles_path.read_text()
        else:
            styles = self._get_default_styles()
        
        # Render template
        html_content = template.render(
            report=report,
            summary=report.get_summary(),
            styles=styles
        )
        
        # Save to file
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        safe_target = report.target.replace("://", "_").replace("/", "_").replace(".", "_")
        filename = f"pentest_report_{safe_target}_{timestamp}.html"
        output_path = self.output_dir / filename
        
        output_path.write_text(html_content, encoding="utf-8")
        
        return output_path
    
    async def _generate_pdf(self, report: PentestReport) -> Path:
        """Generate PDF report"""
        # First generate HTML
        html_path = await self._generate_html(report)
        html_content = html_path.read_text()
        
        pdf_path = html_path.with_suffix(".pdf")
        
        try:
            from weasyprint import HTML
            HTML(string=html_content).write_pdf(str(pdf_path))
            console.print("[green]âœ“[/green] PDF generated successfully")
        except ImportError:
            console.print("[yellow]WeasyPrint not installed. HTML report generated instead.[/yellow]")
            console.print("[dim]Install with: pip install weasyprint[/dim]")
            return html_path
        except Exception as e:
            console.print(f"[yellow]PDF generation failed: {str(e)}[/yellow]")
            console.print("[dim]HTML report available as fallback[/dim]")
            return html_path
        
        return pdf_path
    
    async def _generate_json(self, report: PentestReport) -> Path:
        """Generate JSON report"""
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        safe_target = report.target.replace("://", "_").replace("/", "_").replace(".", "_")
        filename = f"pentest_report_{safe_target}_{timestamp}.json"
        output_path = self.output_dir / filename
        
        with open(output_path, "w", encoding="utf-8") as f:
            json.dump(report.to_dict(), f, indent=2, default=str)
        
        return output_path
    
    def create_finding_from_vuln(
        self,
        vuln: Dict[str, Any],
        finding_id: str
    ) -> Finding:
        """Create a Finding from vulnerability scan data"""
        return Finding(
            id=finding_id,
            title=vuln.get("type", "Unknown Vulnerability"),
            severity=vuln.get("severity", "info"),
            category=vuln.get("type", "General"),
            description=vuln.get("description", ""),
            impact=self._get_impact_text(vuln.get("severity", "info")),
            remediation=vuln.get("remediation", ""),
            evidence=vuln.get("evidence", ""),
            url=vuln.get("url", ""),
            parameter=vuln.get("parameter", ""),
            cwe_id=vuln.get("cwe_id", ""),
            cvss_score=vuln.get("cvss_score", 0.0),
        )
    
    def _get_impact_text(self, severity: str) -> str:
        """Get impact description based on severity"""
        impacts = {
            "critical": "This vulnerability could lead to complete system compromise, data breach, or significant financial loss.",
            "high": "This vulnerability poses significant risk and could lead to unauthorized access or data exposure.",
            "medium": "This vulnerability could be exploited under certain conditions and may lead to information disclosure.",
            "low": "This vulnerability has limited impact but should be addressed to improve security posture.",
            "info": "This is an informational finding that may help improve security configuration.",
        }
        return impacts.get(severity.lower(), impacts["info"])
