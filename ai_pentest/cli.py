#!/usr/bin/env python3
"""
AI Pentest Tool - Command Line Interface
=========================================

Main CLI for the AI-assisted penetration testing tool.
"""

import asyncio
import sys
from datetime import datetime
from pathlib import Path
from typing import Optional, List

import typer
from rich.console import Console
from rich.panel import Panel
from rich.table import Table
from rich.progress import Progress, SpinnerColumn, TextColumn
from rich import print as rprint

from .config import get_settings, Settings
from .ai.cursor_client import CursorAIClient, AIProvider
from .scanners.network import NetworkScanner
from .scanners.web import WebScanner, Vulnerability
from .scanners.subdomain import SubdomainEnumerator
from .scanners.ssl_scanner import SSLScanner
from .scanners.ports import PortScanner
from .reports.generator import ReportGenerator, PentestReport, Finding


console = Console()
app = typer.Typer(
    name="ai-pentest",
    help="ğŸ”’ AI-Assisted Penetration Testing Tool",
    add_completion=False,
)


def show_banner():
    """Display tool banner"""
    banner = """
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                                                              â•‘
    â•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—       â•‘
    â•‘    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•       â•‘
    â•‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘          â•‘
    â•‘    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘          â•‘
    â•‘    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘          â•‘
    â•‘    â•šâ•â•  â•šâ•â•â•šâ•â•    â•šâ•â•     â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•â•   â•šâ•â•          â•‘
    â•‘                                                              â•‘
    â•‘         AI-Assisted Penetration Testing Tool v1.0            â•‘
    â•‘                                                              â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """
    console.print(banner, style="bold cyan")


@app.command()
def scan(
    target: str = typer.Argument(..., help="Target URL, domain, or IP address"),
    scan_type: str = typer.Option(
        "full",
        "--type", "-t",
        help="Scan type: full, web, network, recon, ssl"
    ),
    ports: str = typer.Option(
        "quick",
        "--ports", "-p",
        help="Port range: quick, common, full, or custom (e.g., 80,443,8080)"
    ),
    output: Optional[str] = typer.Option(
        None,
        "--output", "-o",
        help="Output directory for reports"
    ),
    report_format: str = typer.Option(
        "html",
        "--format", "-f",
        help="Report format: html, pdf, json"
    ),
    no_ai: bool = typer.Option(
        False,
        "--no-ai",
        help="Disable AI-enhanced analysis"
    ),
    verbose: bool = typer.Option(
        False,
        "--verbose", "-v",
        help="Enable verbose output"
    ),
):
    """
    ğŸ” Perform a comprehensive security scan
    
    Examples:
        ai-pentest scan example.com
        ai-pentest scan https://example.com --type web
        ai-pentest scan 192.168.1.1 --type network --ports full
    """
    show_banner()
    
    console.print(f"\n[bold]Target:[/bold] {target}")
    console.print(f"[bold]Scan Type:[/bold] {scan_type}")
    console.print(f"[bold]AI Enhanced:[/bold] {'No' if no_ai else 'Yes'}\n")
    
    try:
        asyncio.run(_run_scan(
            target=target,
            scan_type=scan_type,
            ports=ports,
            output=output,
            report_format=report_format,
            use_ai=not no_ai,
            verbose=verbose
        ))
    except KeyboardInterrupt:
        console.print("\n[yellow]Scan interrupted by user[/yellow]")
        sys.exit(1)
    except Exception as e:
        console.print(f"\n[red]Error: {str(e)}[/red]")
        if verbose:
            console.print_exception()
        sys.exit(1)


async def _run_scan(
    target: str,
    scan_type: str,
    ports: str,
    output: Optional[str],
    report_format: str,
    use_ai: bool,
    verbose: bool
):
    """Execute the scan"""
    start_time = datetime.now()
    findings: List[Finding] = []
    
    # Initialize report
    report = PentestReport(
        title=f"Penetration Test Report - {target}",
        target=target,
        start_date=start_time,
    )
    
    # Run appropriate scan
    if scan_type in ["full", "network"]:
        console.print(Panel("[bold]Network Reconnaissance[/bold]", style="cyan"))
        network_scanner = NetworkScanner()
        network_result = await network_scanner.scan(
            target=target,
            port_scan=True,
            port_range=ports
        )
        report.network_findings = network_result.to_dict()
        
        # Convert to findings
        if network_result.port_scan:
            for port in network_result.port_scan.ports:
                findings.append(Finding(
                    id=f"NET-{len(findings)+1:03d}",
                    title=f"Open Port: {port.port}/{port.service}",
                    severity="info",
                    category="Network",
                    description=f"Port {port.port} is open running {port.service}",
                    impact="Open ports expose services that may be vulnerable",
                    remediation="Ensure only necessary ports are exposed and services are hardened",
                    evidence=port.banner if port.banner else "",
                ))
    
    if scan_type in ["full", "recon"]:
        console.print(Panel("[bold]Subdomain Enumeration[/bold]", style="cyan"))
        subdomain_enum = SubdomainEnumerator()
        subdomain_result = await subdomain_enum.enumerate(
            domain=target.replace("https://", "").replace("http://", "").split("/")[0],
            check_alive=True
        )
        report.subdomain_findings = subdomain_result.to_dict()
    
    if scan_type in ["full", "ssl"]:
        console.print(Panel("[bold]SSL/TLS Analysis[/bold]", style="cyan"))
        ssl_scanner = SSLScanner()
        ssl_result = await ssl_scanner.scan(
            target=target.replace("https://", "").replace("http://", "").split("/")[0]
        )
        report.ssl_findings = ssl_result.to_dict()
        
        # Convert to findings
        for vuln in ssl_result.vulnerabilities:
            findings.append(Finding(
                id=f"SSL-{len(findings)+1:03d}",
                title=vuln.name,
                severity=vuln.severity,
                category="SSL/TLS",
                description=vuln.description,
                impact="SSL/TLS vulnerabilities can lead to data interception",
                remediation=vuln.remediation,
                cwe_id=vuln.cve if vuln.cve else "",
            ))
    
    if scan_type in ["full", "web"]:
        console.print(Panel("[bold]Web Application Scanning[/bold]", style="cyan"))
        web_scanner = WebScanner()
        web_result = await web_scanner.scan(
            target=target,
            depth=2,
            check_xss=True,
            check_sqli=True,
            check_lfi=True
        )
        report.web_findings = web_result.to_dict()
        
        # Convert to findings
        for vuln in web_result.vulnerabilities:
            findings.append(Finding(
                id=f"WEB-{len(findings)+1:03d}",
                title=vuln.vuln_type.value,
                severity=vuln.severity.value,
                category="Web Application",
                description=vuln.description,
                impact="Web vulnerabilities can lead to data theft or system compromise",
                remediation=vuln.remediation,
                evidence=vuln.evidence,
                url=vuln.url,
                parameter=vuln.parameter,
                cwe_id=vuln.cwe_id,
                cvss_score=vuln.cvss_score,
            ))
    
    # Add findings to report
    report.findings = findings
    report.end_date = datetime.now()
    
    # AI Analysis
    if use_ai and findings:
        console.print(Panel("[bold]AI-Powered Analysis[/bold]", style="cyan"))
        
        async with CursorAIClient() as ai:
            # Analyze findings
            with Progress(
                SpinnerColumn(),
                TextColumn("[progress.description]{task.description}"),
                console=console,
            ) as progress:
                task = progress.add_task("Analyzing findings...", total=None)
                
                analysis = await ai.analyze(
                    prompt="Analyze these security findings and provide a risk assessment",
                    context={"findings": [f.to_dict() for f in findings[:10]]},  # Limit for API
                    system_prompt=ai.settings.cursor.model
                )
                
                progress.update(task, completed=True)
            
            if analysis.content:
                console.print("\n[bold]AI Analysis:[/bold]")
                console.print(Panel(analysis.content[:2000], style="dim"))
    
    # Generate Report
    console.print(Panel("[bold]Generating Report[/bold]", style="cyan"))
    
    generator = ReportGenerator(output_dir=output)
    report_path = await generator.generate(
        report=report,
        format=report_format,
        use_ai=use_ai
    )
    
    # Summary
    duration = (datetime.now() - start_time).total_seconds()
    summary = report.get_summary()
    
    console.print("\n")
    console.print(Panel(
        f"""
[bold]Scan Complete![/bold]

Target: {target}
Duration: {duration:.1f} seconds
Total Findings: {len(findings)}

[red]Critical: {summary['critical']}[/red]
[orange1]High: {summary['high']}[/orange1]
[yellow]Medium: {summary['medium']}[/yellow]
[green]Low: {summary['low']}[/green]
[blue]Info: {summary['info']}[/blue]

Report: {report_path}
        """,
        title="Summary",
        style="green"
    ))


@app.command()
def web(
    target: str = typer.Argument(..., help="Target URL"),
    depth: int = typer.Option(2, "--depth", "-d", help="Crawl depth"),
    no_xss: bool = typer.Option(False, "--no-xss", help="Skip XSS tests"),
    no_sqli: bool = typer.Option(False, "--no-sqli", help="Skip SQL injection tests"),
):
    """
    ğŸŒ Web application security scan
    """
    show_banner()
    
    async def run():
        scanner = WebScanner()
        result = await scanner.scan(
            target=target,
            depth=depth,
            check_xss=not no_xss,
            check_sqli=not no_sqli
        )
        
        console.print("\n[bold green]Web scan complete![/bold green]")
        console.print(f"Vulnerabilities found: {len(result.vulnerabilities)}")
    
    asyncio.run(run())


@app.command()
def network(
    target: str = typer.Argument(..., help="Target IP or hostname"),
    ports: str = typer.Option("quick", "--ports", "-p", help="Port range"),
):
    """
    ğŸ”Œ Network reconnaissance scan
    """
    show_banner()
    
    async def run():
        scanner = NetworkScanner()
        result = await scanner.scan(target=target, port_range=ports)
        
        console.print("\n[bold green]Network scan complete![/bold green]")
    
    asyncio.run(run())


@app.command()
def subdomains(
    domain: str = typer.Argument(..., help="Target domain"),
    wordlist: Optional[str] = typer.Option(None, "--wordlist", "-w", help="Custom wordlist file"),
    no_bruteforce: bool = typer.Option(False, "--no-bruteforce", help="Skip DNS bruteforce"),
):
    """
    ğŸ” Subdomain enumeration
    """
    show_banner()
    
    async def run():
        custom_wordlist = None
        if wordlist:
            with open(wordlist) as f:
                custom_wordlist = [line.strip() for line in f if line.strip()]
        
        enumerator = SubdomainEnumerator()
        result = await enumerator.enumerate(
            domain=domain,
            bruteforce=not no_bruteforce,
            custom_wordlist=custom_wordlist
        )
        
        console.print(f"\n[bold green]Found {result.total_found} subdomains![/bold green]")
        console.print(f"Alive: {result.alive_count}")
    
    asyncio.run(run())


@app.command()
def ssl(
    target: str = typer.Argument(..., help="Target hostname"),
    port: int = typer.Option(443, "--port", "-p", help="Port number"),
):
    """
    ğŸ” SSL/TLS security analysis
    """
    show_banner()
    
    async def run():
        scanner = SSLScanner()
        result = await scanner.scan(target=target, port=port)
        
        console.print(f"\n[bold]SSL Grade: {result.grade.value}[/bold]")
    
    asyncio.run(run())


@app.command()
def analyze(
    finding: str = typer.Argument(..., help="Finding description or file"),
    target: str = typer.Option("", "--target", "-t", help="Target context"),
):
    """
    ğŸ¤– AI-powered vulnerability analysis
    """
    show_banner()
    
    async def run():
        # Check if it's a file
        if Path(finding).exists():
            with open(finding) as f:
                content = f.read()
        else:
            content = finding
        
        async with CursorAIClient() as ai:
            console.print("[cyan]Analyzing with AI...[/cyan]\n")
            
            response = await ai.analyze(
                prompt=f"Analyze this security finding and provide detailed recommendations:\n\n{content}",
                context={"target": target} if target else None
            )
            
            console.print(Panel(response.content, title="AI Analysis", style="green"))
    
    asyncio.run(run())


@app.command()
def report(
    input_file: str = typer.Argument(..., help="JSON scan results file"),
    output: Optional[str] = typer.Option(None, "--output", "-o", help="Output directory"),
    format: str = typer.Option("html", "--format", "-f", help="Output format: html, pdf, json"),
):
    """
    ğŸ“„ Generate report from scan results
    """
    show_banner()
    
    import json
    
    async def run():
        with open(input_file) as f:
            data = json.load(f)
        
        # Create report from data
        report = PentestReport(
            title=data.get("title", "Penetration Test Report"),
            target=data.get("target", "Unknown"),
            findings=[
                Finding(**f) for f in data.get("findings", [])
            ]
        )
        
        generator = ReportGenerator(output_dir=output)
        report_path = await generator.generate(report, format=format)
        
        console.print(f"[green]Report generated: {report_path}[/green]")
    
    asyncio.run(run())


@app.command()
def config(
    show: bool = typer.Option(False, "--show", "-s", help="Show current configuration"),
    api_key: Optional[str] = typer.Option(None, "--api-key", help="Set API key"),
):
    """
    âš™ï¸  Configuration management
    """
    if show:
        settings = get_settings()
        
        table = Table(title="Current Configuration")
        table.add_column("Setting", style="cyan")
        table.add_column("Value", style="white")
        
        table.add_row("API Key", "***" + settings.cursor.api_key[-4:] if settings.cursor.api_key else "Not set")
        table.add_row("Model", settings.cursor.model)
        table.add_row("Max Tokens", str(settings.cursor.max_tokens))
        table.add_row("Report Format", settings.report.format)
        table.add_row("Output Dir", settings.report.output_dir)
        
        console.print(table)
    
    if api_key:
        import os
        os.environ["CURSOR_API_KEY"] = api_key
        console.print("[green]API key set for this session[/green]")
        console.print("[dim]For permanent configuration, set CURSOR_API_KEY environment variable[/dim]")


@app.command()
def tools(
    check: bool = typer.Option(False, "--check", "-c", help="Check installed tools"),
    category: Optional[str] = typer.Option(None, "--category", help="Filter by category"),
):
    """
    ğŸ”§ List and check available security tools
    """
    from .tools import ToolManager
    
    show_banner()
    manager = ToolManager()
    
    if check:
        manager.check_installed_tools()
    else:
        console.print("\n[bold]Available Tool Categories:[/bold]")
        console.print("  â€¢ network  - Nmap, Masscan, Rustscan, Amass, Subfinder, Nuclei, etc.")
        console.print("  â€¢ web      - Gobuster, Feroxbuster, Nikto, SQLMap, WPScan, Dalfox, etc.")
        console.print("  â€¢ password - Hydra, John, Hashcat, Medusa, CrackMapExec, etc.")
        console.print("  â€¢ binary   - Binwalk, Checksec, Strings, Radare2, Volatility, etc.")
        console.print("  â€¢ cloud    - Prowler, Scout Suite, Trivy, Kube-hunter, etc.")
        console.print("\n[dim]Use --check to see which tools are installed[/dim]")


@app.command()
def run_tool(
    tool_name: str = typer.Argument(..., help="Tool name (e.g., NmapScanner, NucleiScanner)"),
    target: str = typer.Argument(..., help="Target to scan"),
    output: Optional[str] = typer.Option(None, "--output", "-o", help="Output directory"),
):
    """
    ğŸ”¨ Run a specific security tool
    """
    from .tools import ToolManager
    
    show_banner()
    
    async def run():
        manager = ToolManager(output_dir=output)
        result = await manager.run_tool(tool_name, target)
        
        if result:
            console.print(f"\n[bold]Results:[/bold]")
            console.print(f"  Status: {result.status.value}")
            console.print(f"  Findings: {len(result.findings)}")
            console.print(f"  Time: {result.execution_time:.2f}s")
            
            if result.findings:
                console.print("\n[bold]Findings:[/bold]")
                for f in result.findings[:10]:
                    console.print(f"  â€¢ [{f.get('severity', 'info').upper()}] {f.get('title', '')}")
    
    asyncio.run(run())


@app.command()
def recon(
    target: str = typer.Argument(..., help="Target domain or IP"),
    output: Optional[str] = typer.Option(None, "--output", "-o", help="Output directory"),
    no_ai: bool = typer.Option(False, "--no-ai", help="Disable AI analysis"),
):
    """
    ğŸ” Run reconnaissance tools (Nmap, Subfinder, Httpx, Nuclei)
    """
    from .tools import ToolManager
    
    show_banner()
    
    async def run():
        manager = ToolManager(output_dir=output, use_ai=not no_ai)
        result = await manager.run_recon(target)
        
        console.print(f"\n[bold green]Reconnaissance Complete![/bold green]")
        console.print(f"  Tools Run: {len(result.tool_results)}")
        console.print(f"  Findings: {len(result.findings)}")
        
        if result.ai_analysis:
            console.print("\n[bold]AI Analysis:[/bold]")
            console.print(result.ai_analysis[:2000])
        
        await manager.close()
    
    asyncio.run(run())


@app.command()
def vuln_scan(
    target: str = typer.Argument(..., help="Target URL"),
    output: Optional[str] = typer.Option(None, "--output", "-o", help="Output directory"),
    no_ai: bool = typer.Option(False, "--no-ai", help="Disable AI analysis"),
):
    """
    ğŸ¯ Run vulnerability scanning tools (Nuclei, Nikto, SQLMap, Dalfox)
    """
    from .tools import ToolManager
    
    show_banner()
    
    async def run():
        manager = ToolManager(output_dir=output, use_ai=not no_ai)
        result = await manager.run_vuln_scan(target)
        
        console.print(f"\n[bold green]Vulnerability Scan Complete![/bold green]")
        console.print(f"  Tools Run: {len(result.tool_results)}")
        console.print(f"  Findings: {len(result.findings)}")
        
        # Show critical/high findings
        critical = [f for f in result.findings if f.severity in ["critical", "high"]]
        if critical:
            console.print(f"\n[bold red]Critical/High Findings ({len(critical)}):[/bold red]")
            for f in critical[:10]:
                console.print(f"  â€¢ [{f.severity.upper()}] {f.title}")
        
        await manager.close()
    
    asyncio.run(run())


@app.command()
def version():
    """
    ğŸ“Œ Show version information
    """
    from . import __version__
    console.print(f"AI Pentest Tool v{__version__}")


def main():
    """Main entry point"""
    app()


if __name__ == "__main__":
    main()
