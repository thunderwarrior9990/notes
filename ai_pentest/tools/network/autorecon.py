"""
AutoRecon Scanner Wrapper
=========================

Multi-threaded network reconnaissance tool.
"""

import os
import re
from pathlib import Path
from typing import Dict, List, Any, Tuple, Optional

from ..base import ToolWrapper


class AutoreconScanner(ToolWrapper):
    """
    AutoRecon - Automated reconnaissance
    
    Features:
    - Automated port scanning
    - Service enumeration
    - Vulnerability scanning
    - Output organization
    """
    
    TOOL_NAME = "AutoRecon"
    BINARY_NAME = "autorecon"
    INSTALL_HINT = "Install with: pip install autorecon"
    
    def build_command(
        self,
        target: str,
        ports: Optional[str] = None,
        single: bool = False,
        only_scans: Optional[List[str]] = None,
        exclude_scans: Optional[List[str]] = None,
        heartbeat: int = 60,
        verbose: int = 0,
        **kwargs
    ) -> List[str]:
        cmd = [self.BINARY_NAME]
        
        if ports:
            cmd.extend(["--ports", ports])
        
        if single:
            cmd.append("--single")
        
        if only_scans:
            cmd.extend(["--only-scans", ",".join(only_scans)])
        
        if exclude_scans:
            cmd.extend(["--exclude-scans", ",".join(exclude_scans)])
        
        cmd.extend(["--heartbeat", str(heartbeat)])
        
        if verbose > 0:
            cmd.append("-" + "v" * verbose)
        
        output_dir = self.output_dir / f"autorecon_{target.replace('.', '_')}"
        cmd.extend(["-o", str(output_dir)])
        
        cmd.append(target)
        
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        findings = []
        raw_data = {"scans_completed": [], "ports": [], "services": [], "vulns": []}
        
        # Parse from output directory structure
        output_dirs = list(self.output_dir.glob("autorecon_*"))
        if output_dirs:
            scan_dir = output_dirs[-1]
            
            # Check for target directories
            for target_dir in scan_dir.iterdir():
                if target_dir.is_dir():
                    # Read scans directory
                    scans_dir = target_dir / "scans"
                    if scans_dir.exists():
                        for scan_file in scans_dir.rglob("*"):
                            if scan_file.is_file():
                                raw_data["scans_completed"].append(scan_file.name)
                                
                                # Parse specific scan outputs
                                try:
                                    content = scan_file.read_text()
                                    
                                    # Nmap results
                                    if "nmap" in scan_file.name.lower():
                                        port_pattern = r"(\d+)/(tcp|udp)\s+open\s+(\S+)"
                                        for match in re.finditer(port_pattern, content):
                                            port_info = {
                                                "port": int(match.group(1)),
                                                "protocol": match.group(2),
                                                "service": match.group(3)
                                            }
                                            if port_info not in raw_data["ports"]:
                                                raw_data["ports"].append(port_info)
                                                findings.append(self._create_finding(
                                                    title=f"Open Port: {port_info['port']}/{port_info['protocol']}",
                                                    severity="info",
                                                    description=f"Service: {port_info['service']}"
                                                ))
                                    
                                    # Look for vulnerabilities
                                    vuln_patterns = [
                                        r"VULNERABLE",
                                        r"CVE-\d{4}-\d+",
                                        r"vulnerability",
                                        r"exploit"
                                    ]
                                    for pattern in vuln_patterns:
                                        if re.search(pattern, content, re.IGNORECASE):
                                            raw_data["vulns"].append({
                                                "file": scan_file.name,
                                                "content": content[:500]
                                            })
                                            break
                                            
                                except Exception:
                                    continue
        
        # Parse command output
        scan_pattern = r"\[\*\]\s+Running\s+(.+)"
        for match in re.finditer(scan_pattern, output):
            raw_data["scans_completed"].append(match.group(1))
        
        return findings, raw_data
