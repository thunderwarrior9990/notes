"""
TheHarvester Scanner Wrapper
============================

OSINT tool for gathering emails, names, subdomains, IPs.
"""

import json
import re
from typing import Dict, List, Any, Tuple, Optional

from ..base import ToolWrapper


class TheHarvesterScanner(ToolWrapper):
    """
    TheHarvester - OSINT tool
    
    Features:
    - Email harvesting
    - Subdomain discovery
    - Virtual host detection
    - Employee name discovery
    """
    
    TOOL_NAME = "TheHarvester"
    BINARY_NAME = "theHarvester"
    INSTALL_HINT = "Install with: pip install theHarvester"
    
    def build_command(
        self,
        target: str,
        sources: Optional[List[str]] = None,
        limit: int = 500,
        start: int = 0,
        shodan: bool = False,
        dns_lookup: bool = True,
        dns_brute: bool = False,
        virtual_host: bool = False,
        **kwargs
    ) -> List[str]:
        cmd = [self.BINARY_NAME]
        
        cmd.extend(["-d", target])
        cmd.extend(["-l", str(limit)])
        cmd.extend(["-S", str(start)])
        
        if sources:
            cmd.extend(["-b", ",".join(sources)])
        else:
            cmd.extend(["-b", "all"])
        
        if shodan:
            cmd.append("-s")
        
        if dns_lookup:
            cmd.append("-n")
        
        if dns_brute:
            cmd.append("-c")
        
        if virtual_host:
            cmd.append("-v")
        
        output_file = self.output_dir / f"theharvester_{target.replace('.', '_')}"
        cmd.extend(["-f", str(output_file)])
        
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        findings = []
        raw_data = {"emails": [], "hosts": [], "ips": [], "urls": [], "asns": []}
        
        # Try JSON output
        json_files = list(self.output_dir.glob("theharvester_*.json"))
        if json_files:
            try:
                with open(json_files[-1]) as f:
                    data = json.load(f)
                    raw_data["emails"] = data.get("emails", [])
                    raw_data["hosts"] = data.get("hosts", [])
                    raw_data["ips"] = data.get("ips", [])
                    raw_data["urls"] = data.get("interesting_urls", [])
                    raw_data["asns"] = data.get("asns", [])
            except Exception:
                pass
        
        # Fallback to text parsing
        if not any([raw_data["emails"], raw_data["hosts"], raw_data["ips"]]):
            # Parse emails
            email_pattern = r"[\w\.-]+@[\w\.-]+\.\w+"
            raw_data["emails"] = list(set(re.findall(email_pattern, output)))
            
            # Parse hosts/subdomains
            in_hosts = False
            for line in output.split("\n"):
                if "[*] Hosts found:" in line:
                    in_hosts = True
                    continue
                if in_hosts and line.strip():
                    if line.startswith("["):
                        in_hosts = False
                    else:
                        parts = line.split(":")
                        if len(parts) >= 1:
                            raw_data["hosts"].append(parts[0].strip())
        
        # Create findings
        if raw_data["emails"]:
            findings.append(self._create_finding(
                title=f"Discovered {len(raw_data['emails'])} Email Addresses",
                severity="info",
                description=f"Emails: {', '.join(raw_data['emails'][:10])}{'...' if len(raw_data['emails']) > 10 else ''}",
                email_count=len(raw_data["emails"])
            ))
            
            # Potential high-value emails
            for email in raw_data["emails"]:
                if any(x in email.lower() for x in ["admin", "root", "ceo", "cto", "cfo", "hr", "finance", "security"]):
                    findings.append(self._create_finding(
                        title=f"High-Value Email: {email}",
                        severity="low",
                        description="Potentially valuable for social engineering",
                        email=email
                    ))
        
        if raw_data["hosts"]:
            findings.append(self._create_finding(
                title=f"Discovered {len(raw_data['hosts'])} Hosts/Subdomains",
                severity="info",
                description=f"Hosts: {', '.join(raw_data['hosts'][:10])}{'...' if len(raw_data['hosts']) > 10 else ''}",
                host_count=len(raw_data["hosts"])
            ))
        
        return findings, raw_data
