"""
Fierce DNS Scanner Wrapper
==========================

DNS reconnaissance tool for locating non-contiguous IP space.
"""

import re
from typing import Dict, List, Any, Tuple, Optional

from ..base import ToolWrapper


class FierceScanner(ToolWrapper):
    """
    Fierce - DNS reconnaissance
    
    Features:
    - DNS enumeration
    - Zone transfer attempts
    - Subdomain brute forcing
    - Wildcard detection
    """
    
    TOOL_NAME = "Fierce"
    BINARY_NAME = "fierce"
    INSTALL_HINT = "Install with: pip install fierce"
    
    def build_command(
        self,
        target: str,
        dns_servers: Optional[List[str]] = None,
        subdomain_file: Optional[str] = None,
        delay: float = 0.0,
        threads: int = 1,
        **kwargs
    ) -> List[str]:
        cmd = [self.BINARY_NAME]
        
        cmd.extend(["--domain", target])
        
        if dns_servers:
            for dns in dns_servers:
                cmd.extend(["--dns-servers", dns])
        
        if subdomain_file:
            cmd.extend(["--subdomain-file", subdomain_file])
        
        if delay > 0:
            cmd.extend(["--delay", str(delay)])
        
        cmd.extend(["--threads", str(threads)])
        
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        findings = []
        raw_data = {"subdomains": [], "zone_transfers": [], "wildcard": False}
        
        # Check for wildcard
        if "Wildcard" in output:
            raw_data["wildcard"] = True
            findings.append(self._create_finding(
                title="DNS Wildcard Detected",
                severity="low",
                description="Domain has wildcard DNS configured"
            ))
        
        # Check for zone transfer
        if "Zone Transfer" in output or "zone transfer" in output.lower():
            raw_data["zone_transfers"].append(target)
            findings.append(self._create_finding(
                title="Zone Transfer Possible",
                severity="high",
                description="DNS zone transfer is allowed",
                remediation="Restrict zone transfers to authorized servers only"
            ))
        
        # Parse subdomains
        subdomain_pattern = r"(\S+\.\S+)\.\s+(?:Found|IN)\s+(?:A|AAAA|CNAME)\s+(\S+)"
        for match in re.finditer(subdomain_pattern, output):
            subdomain = match.group(1)
            record = match.group(2)
            raw_data["subdomains"].append({"name": subdomain, "record": record})
            
            findings.append(self._create_finding(
                title=f"DNS Record: {subdomain}",
                severity="info",
                description=f"Resolves to: {record}",
                subdomain=subdomain,
                record=record
            ))
        
        return findings, raw_data
