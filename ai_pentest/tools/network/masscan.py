"""
Masscan Scanner Wrapper
=======================

Fast port scanner - scans the entire Internet in under 6 minutes.
"""

import json
import re
from typing import Dict, List, Any, Tuple, Optional

from ..base import ToolWrapper


class MasscanScanner(ToolWrapper):
    """
    Masscan - Mass IP port scanner
    
    Features:
    - Extremely fast port scanning
    - Supports large IP ranges
    - Banner grabbing
    """
    
    TOOL_NAME = "Masscan"
    BINARY_NAME = "masscan"
    INSTALL_HINT = "Install with: apt install masscan / brew install masscan"
    
    INSTALL_COMMANDS = {
        "apt": "sudo apt-get install -y masscan",
        "brew": "brew install masscan",
        "dnf": "sudo dnf install -y masscan",
    }
    
    REQUIRES_NETWORK = True
    OFFLINE_CAPABLE = False
    
    def build_command(
        self,
        target: str,
        ports: str = "1-65535",
        rate: int = 10000,
        banners: bool = True,
        **kwargs
    ) -> List[str]:
        """
        Build masscan command
        
        Args:
            target: Target IP/range (CIDR notation supported)
            ports: Port specification
            rate: Packets per second
            banners: Grab banners
        """
        cmd = [self.BINARY_NAME]
        
        # Target
        cmd.append(target)
        
        # Ports
        cmd.extend(["-p", ports])
        
        # Rate
        cmd.extend(["--rate", str(rate)])
        
        # Banners
        if banners:
            cmd.append("--banners")
        
        # Output
        output_file = self.output_dir / f"masscan_{target.replace('/', '_')}.json"
        cmd.extend(["-oJ", str(output_file)])
        
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        """Parse masscan output"""
        findings = []
        raw_data = {"hosts": [], "open_ports": []}
        
        # Try to read JSON output file
        json_files = list(self.output_dir.glob("masscan_*.json"))
        if json_files:
            try:
                with open(json_files[-1]) as f:
                    content = f.read()
                    # Masscan JSON is newline-delimited
                    for line in content.strip().split("\n"):
                        if line.startswith("{"):
                            try:
                                entry = json.loads(line.rstrip(","))
                                if "ports" in entry:
                                    for port_info in entry["ports"]:
                                        port_data = {
                                            "ip": entry.get("ip", ""),
                                            "port": port_info.get("port", 0),
                                            "protocol": port_info.get("proto", "tcp"),
                                            "status": port_info.get("status", ""),
                                            "service": port_info.get("service", {}).get("name", ""),
                                            "banner": port_info.get("service", {}).get("banner", "")
                                        }
                                        raw_data["open_ports"].append(port_data)
                                        
                                        findings.append(self._create_finding(
                                            title=f"Open Port: {port_data['ip']}:{port_data['port']}",
                                            severity="info",
                                            description=f"Port {port_data['port']}/{port_data['protocol']} is open",
                                            evidence=port_data.get("banner", ""),
                                            ip=port_data["ip"],
                                            port=port_data["port"]
                                        ))
                            except json.JSONDecodeError:
                                continue
            except Exception:
                pass
        
        # Fallback to text parsing
        if not raw_data["open_ports"]:
            pattern = r"Discovered open port (\d+)/(tcp|udp) on (\d+\.\d+\.\d+\.\d+)"
            for match in re.finditer(pattern, output):
                port_data = {
                    "port": int(match.group(1)),
                    "protocol": match.group(2),
                    "ip": match.group(3)
                }
                raw_data["open_ports"].append(port_data)
                findings.append(self._create_finding(
                    title=f"Open Port: {port_data['ip']}:{port_data['port']}",
                    severity="info",
                    description=f"Port {port_data['port']}/{port_data['protocol']} is open"
                ))
        
        return findings, raw_data
