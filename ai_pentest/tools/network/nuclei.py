"""
Nuclei Scanner Wrapper
======================

Fast and customizable vulnerability scanner.
"""

import json
from typing import Dict, List, Any, Tuple, Optional

from ..base import ToolWrapper


class NucleiScanner(ToolWrapper):
    """
    Nuclei - Vulnerability Scanner
    
    Features:
    - Template-based scanning
    - Multiple protocols (HTTP, DNS, TCP, etc.)
    - Community templates
    - Fast parallel scanning
    """
    
    TOOL_NAME = "Nuclei"
    BINARY_NAME = "nuclei"
    INSTALL_HINT = "Install with: go install github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest"
    
    def build_command(
        self,
        target: str,
        templates: Optional[List[str]] = None,
        severity: Optional[List[str]] = None,
        tags: Optional[List[str]] = None,
        exclude_tags: Optional[List[str]] = None,
        rate_limit: int = 150,
        bulk_size: int = 25,
        concurrency: int = 25,
        headless: bool = False,
        new_templates: bool = False,
        **kwargs
    ) -> List[str]:
        """
        Build nuclei command
        
        Args:
            target: Target URL/host
            templates: Specific templates to use
            severity: Filter by severity (info, low, medium, high, critical)
            tags: Filter by tags
            exclude_tags: Exclude templates with tags
            rate_limit: Rate limit
            bulk_size: Bulk size
            concurrency: Max concurrent templates
            headless: Enable headless browser
            new_templates: Check for new templates
        """
        cmd = [self.BINARY_NAME]
        
        # Target
        cmd.extend(["-u", target])
        
        # Templates
        if templates:
            for template in templates:
                cmd.extend(["-t", template])
        
        # Severity filter
        if severity:
            cmd.extend(["-s", ",".join(severity)])
        
        # Tags
        if tags:
            cmd.extend(["-tags", ",".join(tags)])
        if exclude_tags:
            cmd.extend(["-etags", ",".join(exclude_tags)])
        
        # Performance
        cmd.extend(["-rl", str(rate_limit)])
        cmd.extend(["-bs", str(bulk_size)])
        cmd.extend(["-c", str(concurrency)])
        
        # Headless
        if headless:
            cmd.append("-headless")
        
        # New templates
        if new_templates:
            cmd.append("-nt")
        
        # Output
        output_file = self.output_dir / f"nuclei_{target.replace('/', '_').replace(':', '_')}.json"
        cmd.extend(["-jsonl", "-o", str(output_file)])
        
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        """Parse nuclei output"""
        findings = []
        raw_data = {"vulnerabilities": [], "info": [], "templates_matched": []}
        
        # Read JSON output
        json_files = list(self.output_dir.glob("nuclei_*.json"))
        if json_files:
            try:
                with open(json_files[-1]) as f:
                    for line in f:
                        try:
                            entry = json.loads(line.strip())
                            
                            vuln_data = {
                                "template_id": entry.get("template-id", ""),
                                "name": entry.get("info", {}).get("name", ""),
                                "severity": entry.get("info", {}).get("severity", "info"),
                                "host": entry.get("host", ""),
                                "matched_at": entry.get("matched-at", ""),
                                "type": entry.get("type", ""),
                                "description": entry.get("info", {}).get("description", ""),
                                "reference": entry.get("info", {}).get("reference", []),
                                "tags": entry.get("info", {}).get("tags", []),
                                "matcher_name": entry.get("matcher-name", ""),
                                "extracted_results": entry.get("extracted-results", [])
                            }
                            
                            raw_data["vulnerabilities"].append(vuln_data)
                            raw_data["templates_matched"].append(vuln_data["template_id"])
                            
                            # Create finding
                            findings.append(self._create_finding(
                                title=vuln_data["name"],
                                severity=vuln_data["severity"],
                                description=vuln_data["description"],
                                evidence=f"Matched at: {vuln_data['matched_at']}",
                                url=vuln_data["matched_at"],
                                template_id=vuln_data["template_id"],
                                references=vuln_data["reference"],
                                tags=vuln_data["tags"]
                            ))
                            
                        except json.JSONDecodeError:
                            continue
            except Exception:
                pass
        
        # Fallback to text parsing
        if not raw_data["vulnerabilities"]:
            import re
            pattern = r"\[(\w+)\]\s+\[([^\]]+)\]\s+\[([^\]]+)\]\s+(.+)"
            for match in re.finditer(pattern, output):
                severity = match.group(1).lower()
                template_id = match.group(2)
                proto = match.group(3)
                target_matched = match.group(4)
                
                findings.append(self._create_finding(
                    title=f"Nuclei: {template_id}",
                    severity=severity,
                    description=f"Template matched: {template_id}",
                    evidence=target_matched,
                    template_id=template_id
                ))
        
        return findings, raw_data
