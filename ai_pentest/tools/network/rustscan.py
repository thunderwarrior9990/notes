"""
Rustscan Scanner Wrapper
========================

Modern port scanner - fast with nmap integration.
"""

import re
from typing import Dict, List, Any, Tuple, Optional

from ..base import ToolWrapper


class RustscanScanner(ToolWrapper):
    """
    Rustscan - The Modern Port Scanner
    
    Features:
    - Extremely fast scanning
    - Automatic nmap integration
    - Adaptive timing
    """
    
    TOOL_NAME = "Rustscan"
    BINARY_NAME = "rustscan"
    INSTALL_HINT = "Install with: cargo install rustscan / docker pull rustscan/rustscan"
    
    INSTALL_COMMANDS = {
        "cargo": "cargo install rustscan",
        "apt": "sudo apt-get install -y rustscan || cargo install rustscan",
        "brew": "brew install rustscan",
    }
    
    REQUIRES_NETWORK = True
    OFFLINE_CAPABLE = False
    
    def build_command(
        self,
        target: str,
        ports: Optional[str] = None,
        batch_size: int = 4500,
        timeout: int = 1500,
        nmap_args: Optional[str] = None,
        ulimit: int = 5000,
        **kwargs
    ) -> List[str]:
        """
        Build rustscan command
        
        Args:
            target: Target IP/hostname
            ports: Port range (default: all ports)
            batch_size: Batch size for port scanning
            timeout: Timeout in ms
            nmap_args: Additional nmap arguments
            ulimit: Ulimit value
        """
        cmd = [self.BINARY_NAME]
        
        # Target
        cmd.extend(["-a", target])
        
        # Ports
        if ports:
            cmd.extend(["-p", ports])
        
        # Batch size
        cmd.extend(["-b", str(batch_size)])
        
        # Timeout
        cmd.extend(["--timeout", str(timeout)])
        
        # Ulimit
        cmd.extend(["--ulimit", str(ulimit)])
        
        # Nmap arguments
        if nmap_args:
            cmd.extend(["--", nmap_args])
        else:
            cmd.extend(["--", "-sV", "-sC"])
        
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        """Parse rustscan output"""
        findings = []
        raw_data = {"open_ports": [], "nmap_output": ""}
        
        # Extract open ports from rustscan output
        port_pattern = r"Open (\d+\.\d+\.\d+\.\d+):(\d+)"
        for match in re.finditer(port_pattern, output):
            port_data = {
                "ip": match.group(1),
                "port": int(match.group(2))
            }
            raw_data["open_ports"].append(port_data)
        
        # Also check for port list format
        ports_line = re.search(r"PORT\s+STATE\s+SERVICE", output)
        if ports_line:
            raw_data["nmap_output"] = output[ports_line.start():]
            
            # Parse nmap-style output
            service_pattern = r"(\d+)/(tcp|udp)\s+open\s+(\S+)\s*(.*)"
            for match in re.finditer(service_pattern, output):
                port_data = {
                    "port": int(match.group(1)),
                    "protocol": match.group(2),
                    "service": match.group(3),
                    "version": match.group(4).strip() if match.group(4) else ""
                }
                
                # Avoid duplicates
                if not any(p.get("port") == port_data["port"] for p in raw_data["open_ports"]):
                    raw_data["open_ports"].append(port_data)
                
                findings.append(self._create_finding(
                    title=f"Open Port: {port_data['port']}/{port_data['protocol']}",
                    severity="info",
                    description=f"Service: {port_data['service']} {port_data['version']}",
                    port=port_data["port"],
                    service=port_data["service"]
                ))
        
        return findings, raw_data
