"""Strings Extractor Wrapper"""
import re
from typing import Dict, List, Any, Tuple, Optional
from ..base import ToolWrapper


class StringsExtractor(ToolWrapper):
    TOOL_NAME = "Strings"
    BINARY_NAME = "strings"
    INSTALL_HINT = "Install with: apt install binutils"
    
    def build_command(self, target: str, min_length: int = 4, encoding: str = "s", **kwargs) -> List[str]:
        cmd = [self.BINARY_NAME, f"-n{min_length}", f"-e{encoding}", target]
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        findings = []
        raw_data = {"strings": [], "interesting": []}
        
        sensitive_patterns = [
            (r"password", "Password reference"),
            (r"api[_-]?key", "API key reference"),
            (r"secret", "Secret reference"),
            (r"private", "Private key reference"),
            (r"-----BEGIN", "PEM key found"),
            (r"mysql://|postgres://|mongodb://", "Database connection string"),
            (r"[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}", "Email address"),
        ]
        
        for line in output.split("\n"):
            line = line.strip()
            if line:
                raw_data["strings"].append(line)
                
                for pattern, desc in sensitive_patterns:
                    if re.search(pattern, line, re.IGNORECASE):
                        raw_data["interesting"].append({"string": line, "type": desc})
                        findings.append(self._create_finding(
                            title=f"Sensitive String: {desc}",
                            severity="medium",
                            description=f"Found: {line[:100]}",
                            evidence=line[:200]
                        ))
                        break
        
        return findings, raw_data
