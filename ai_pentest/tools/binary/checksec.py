"""Checksec Analyzer Wrapper"""
import json
import re
from typing import Dict, List, Any, Tuple, Optional
from ..base import ToolWrapper


class ChecksecAnalyzer(ToolWrapper):
    TOOL_NAME = "Checksec"
    BINARY_NAME = "checksec"
    INSTALL_HINT = "Install with: apt install checksec"
    
    def build_command(self, target: str, **kwargs) -> List[str]:
        return [self.BINARY_NAME, "--file", target, "--format=json"]
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        findings = []
        raw_data = {}
        
        try:
            data = json.loads(output)
            for filename, info in data.items():
                raw_data = info
                
                if info.get("canary") == "no":
                    findings.append(self._create_finding(
                        title="No Stack Canary",
                        severity="high",
                        description="Binary lacks stack canary protection",
                        remediation="Compile with -fstack-protector-all"
                    ))
                
                if info.get("nx") == "no":
                    findings.append(self._create_finding(
                        title="NX Disabled",
                        severity="critical",
                        description="No-Execute protection is disabled",
                        remediation="Compile with -Wl,-z,noexecstack"
                    ))
                
                if info.get("pie") == "no":
                    findings.append(self._create_finding(
                        title="No PIE",
                        severity="medium",
                        description="Position Independent Executable disabled",
                        remediation="Compile with -fPIE -pie"
                    ))
                
                if info.get("relro") == "no":
                    findings.append(self._create_finding(
                        title="No RELRO",
                        severity="medium",
                        description="RELRO protection disabled",
                        remediation="Compile with -Wl,-z,relro,-z,now"
                    ))
        except json.JSONDecodeError:
            pass
        
        return findings, raw_data
