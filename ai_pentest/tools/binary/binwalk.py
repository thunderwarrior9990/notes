"""Binwalk Analyzer Wrapper"""
import re
from typing import Dict, List, Any, Tuple, Optional
from ..base import ToolWrapper


class BinwalkAnalyzer(ToolWrapper):
    TOOL_NAME = "Binwalk"
    BINARY_NAME = "binwalk"
    INSTALL_HINT = "Install with: apt install binwalk"
    
    def build_command(self, target: str, extract: bool = False, entropy: bool = False, signature: bool = True, **kwargs) -> List[str]:
        cmd = [self.BINARY_NAME]
        
        if extract:
            cmd.append("-e")
        if entropy:
            cmd.append("-E")
        if signature:
            cmd.append("-B")
        
        cmd.append(target)
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        findings = []
        raw_data = {"signatures": [], "embedded_files": []}
        
        sig_pattern = r"(\d+)\s+0x([0-9A-Fa-f]+)\s+(.+)"
        for match in re.finditer(sig_pattern, output):
            sig = {"offset": match.group(1), "hex_offset": match.group(2), "description": match.group(3)}
            raw_data["signatures"].append(sig)
            
            if any(x in sig["description"].lower() for x in ["password", "key", "secret", "private"]):
                findings.append(self._create_finding(
                    title=f"Sensitive Data in Binary",
                    severity="medium",
                    description=sig["description"],
                    evidence=f"Offset: {sig['offset']}"
                ))
        
        return findings, raw_data
