"""Exiftool Analyzer Wrapper"""
import json
from typing import Dict, List, Any, Tuple, Optional
from ..base import ToolWrapper


class ExiftoolAnalyzer(ToolWrapper):
    TOOL_NAME = "Exiftool"
    BINARY_NAME = "exiftool"
    INSTALL_HINT = "Install with: apt install libimage-exiftool-perl"
    
    def build_command(self, target: str, **kwargs) -> List[str]:
        return [self.BINARY_NAME, "-j", target]
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        findings = []
        raw_data = {}
        
        try:
            data = json.loads(output)
            if data:
                raw_data = data[0]
                
                sensitive_fields = ["GPSLatitude", "GPSLongitude", "Author", "Creator", "Producer", "Comment"]
                for field in sensitive_fields:
                    if field in raw_data and raw_data[field]:
                        findings.append(self._create_finding(
                            title=f"Metadata: {field}",
                            severity="low",
                            description=f"Value: {raw_data[field]}",
                            metadata_field=field
                        ))
        except json.JSONDecodeError:
            raw_data = {"output": output}
        
        return findings, raw_data
