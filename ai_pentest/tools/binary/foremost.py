"""Foremost Carver Wrapper"""
import os
from typing import Dict, List, Any, Tuple, Optional
from ..base import ToolWrapper


class ForemostCarver(ToolWrapper):
    TOOL_NAME = "Foremost"
    BINARY_NAME = "foremost"
    INSTALL_HINT = "Install with: apt install foremost"
    
    INSTALL_COMMANDS = {
        "apt": "sudo apt-get install -y foremost",
        "brew": "brew install foremost",
    }
    
    REQUIRES_NETWORK = False
    OFFLINE_CAPABLE = True
    
    def build_command(self, target: str, types: Optional[str] = None, **kwargs) -> List[str]:
        output_dir = self.output_dir / "foremost_output"
        cmd = [self.BINARY_NAME, "-i", target, "-o", str(output_dir)]
        if types:
            cmd.extend(["-t", types])
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        findings = []
        raw_data = {"files_recovered": [], "types": []}
        
        output_dir = self.output_dir / "foremost_output"
        if output_dir.exists():
            for type_dir in output_dir.iterdir():
                if type_dir.is_dir() and type_dir.name != "audit.txt":
                    raw_data["types"].append(type_dir.name)
                    for f in type_dir.iterdir():
                        raw_data["files_recovered"].append(str(f))
            
            if raw_data["files_recovered"]:
                findings.append(self._create_finding(
                    title=f"Recovered {len(raw_data['files_recovered'])} Files",
                    severity="info",
                    description=f"Types: {', '.join(raw_data['types'])}"
                ))
        
        return findings, raw_data
