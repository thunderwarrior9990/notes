"""
Hash Identifier Wrapper
=======================

Hash type identification tool.
"""

import re
from typing import Dict, List, Any, Tuple, Optional

from ..base import ToolWrapper


class HashIdentifier(ToolWrapper):
    TOOL_NAME = "Hash-Identifier"
    BINARY_NAME = "hash-identifier"
    INSTALL_HINT = "Install with: pip install hashid"
    
    # Also support hashid
    def get_binary_path(self) -> Optional[str]:
        import shutil
        path = shutil.which("hash-identifier")
        if not path:
            path = shutil.which("hashid")
        return path
    
    def build_command(
        self,
        target: str,  # Hash to identify
        extended: bool = True,
        **kwargs
    ) -> List[str]:
        binary = self.get_binary_path()
        
        if "hashid" in str(binary):
            cmd = ["hashid"]
            if extended:
                cmd.append("-e")
            cmd.append(target)
        else:
            cmd = ["hash-identifier", target]
        
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        findings = []
        raw_data = {"possible_types": [], "hash": ""}
        
        # Parse hashid output
        type_pattern = r"\[[\+\*]\]\s+(.+)"
        for match in re.finditer(type_pattern, output):
            hash_type = match.group(1).strip()
            raw_data["possible_types"].append(hash_type)
        
        # Parse hash-identifier output
        if not raw_data["possible_types"]:
            section_pattern = r"Possible Hashs:\s*\n((?:[^\n]+\n)+)"
            section_match = re.search(section_pattern, output)
            if section_match:
                for line in section_match.group(1).split("\n"):
                    if line.strip() and line.strip().startswith("["):
                        continue
                    if line.strip():
                        raw_data["possible_types"].append(line.strip())
        
        if raw_data["possible_types"]:
            findings.append(self._create_finding(
                title=f"Hash Identified",
                severity="info",
                description=f"Possible types: {', '.join(raw_data['possible_types'][:5])}",
                hash_types=raw_data["possible_types"]
            ))
        
        return findings, raw_data
