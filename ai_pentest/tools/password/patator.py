"""
Patator Attacker Wrapper
========================

Multi-purpose brute-forcer.
"""

import re
from typing import Dict, List, Any, Tuple, Optional

from ..base import ToolWrapper


class PatatorAttacker(ToolWrapper):
    TOOL_NAME = "Patator"
    BINARY_NAME = "patator"
    INSTALL_HINT = "Install with: apt install patator"
    
    def build_command(
        self,
        target: str,
        module: str = "ssh_login",
        user: Optional[str] = None,
        password: Optional[str] = None,
        user_file: Optional[str] = None,
        pass_file: Optional[str] = None,
        port: int = 22,
        threads: int = 10,
        **kwargs
    ) -> List[str]:
        cmd = [self.BINARY_NAME, module]
        
        cmd.extend([f"host={target}"])
        cmd.extend([f"port={port}"])
        
        if user_file:
            cmd.extend([f"user=FILE0", f"0={user_file}"])
        elif user:
            cmd.extend([f"user={user}"])
        
        if pass_file:
            cmd.extend([f"password=FILE1", f"1={pass_file}"])
        elif password:
            cmd.extend([f"password={password}"])
        
        cmd.extend(["-t", str(threads)])
        cmd.extend(["-x", "ignore:mesg='Authentication failed.'"])
        
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        findings = []
        raw_data = {"credentials": []}
        
        # Parse successful attempts
        success_pattern = r"(\d+)\s+(\d+:\d+:\d+)\s+\+\d+\s+(.+)"
        for match in re.finditer(success_pattern, output):
            info = match.group(3)
            
            user_match = re.search(r"user='([^']+)'", info)
            pass_match = re.search(r"password='([^']+)'", info)
            
            if user_match and pass_match:
                cred = {
                    "username": user_match.group(1),
                    "password": pass_match.group(1)
                }
                raw_data["credentials"].append(cred)
                
                findings.append(self._create_finding(
                    title=f"Valid Credentials Found",
                    severity="critical",
                    description=f"User: {cred['username']}",
                    evidence=f"Password: {cred['password']}",
                    username=cred["username"]
                ))
        
        return findings, raw_data
