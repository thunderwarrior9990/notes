"""
Evil-WinRM Wrapper
==================

Windows Remote Management shell.
"""

from typing import Dict, List, Any, Tuple, Optional

from ..base import ToolWrapper


class EvilWinrmShell(ToolWrapper):
    TOOL_NAME = "Evil-WinRM"
    BINARY_NAME = "evil-winrm"
    INSTALL_HINT = "Install with: gem install evil-winrm"
    
    def build_command(
        self,
        target: str,
        username: str,
        password: Optional[str] = None,
        hash: Optional[str] = None,
        ssl: bool = False,
        port: int = 5985,
        scripts: Optional[str] = None,
        executables: Optional[str] = None,
        **kwargs
    ) -> List[str]:
        cmd = [self.BINARY_NAME]
        
        cmd.extend(["-i", target])
        cmd.extend(["-u", username])
        
        if password:
            cmd.extend(["-p", password])
        elif hash:
            cmd.extend(["-H", hash])
        
        if ssl:
            cmd.append("-S")
            if port == 5985:
                port = 5986
        
        cmd.extend(["-P", str(port)])
        
        if scripts:
            cmd.extend(["-s", scripts])
        
        if executables:
            cmd.extend(["-e", executables])
        
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        findings = []
        raw_data = {"connected": False, "shell_type": ""}
        
        if "Evil-WinRM shell" in output:
            raw_data["connected"] = True
            raw_data["shell_type"] = "WinRM"
            
            findings.append(self._create_finding(
                title="WinRM Shell Established",
                severity="critical",
                description="Successfully connected to target via WinRM",
                evidence="Evil-WinRM shell session established"
            ))
        
        return findings, raw_data
