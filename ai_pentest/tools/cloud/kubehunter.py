"""
Kube-hunter Scanner Wrapper
===========================

Kubernetes penetration testing tool.
"""

import json
from typing import Dict, List, Any, Tuple, Optional
from ..base import ToolWrapper


class KubeHunterScanner(ToolWrapper):
    TOOL_NAME = "Kube-hunter"
    BINARY_NAME = "kube-hunter"
    INSTALL_HINT = "Install with: pip install kube-hunter"
    
    def build_command(
        self,
        target: str = "",
        remote: bool = False,
        internal: bool = False,
        pod: bool = False,
        quick: bool = False,
        active: bool = False,
        **kwargs
    ) -> List[str]:
        cmd = [self.BINARY_NAME]
        
        if remote and target:
            cmd.extend(["--remote", target])
        elif internal:
            cmd.append("--internal")
        elif pod:
            cmd.append("--pod")
        
        if quick:
            cmd.append("--quick")
        
        if active:
            cmd.append("--active")
        
        cmd.append("--report=json")
        
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        findings = []
        raw_data = {"nodes": [], "services": [], "vulnerabilities": []}
        
        try:
            data = json.loads(output)
            
            raw_data["nodes"] = data.get("nodes", [])
            raw_data["services"] = data.get("services", [])
            
            for vuln in data.get("vulnerabilities", []):
                raw_data["vulnerabilities"].append(vuln)
                
                severity_map = {"low": "low", "medium": "medium", "high": "high", "critical": "critical"}
                severity = severity_map.get(vuln.get("severity", "").lower(), "info")
                
                findings.append(self._create_finding(
                    title=vuln.get("vulnerability", ""),
                    severity=severity,
                    description=vuln.get("description", ""),
                    evidence=vuln.get("evidence", ""),
                    location=vuln.get("location", ""),
                    category=vuln.get("category", "")
                ))
        except json.JSONDecodeError:
            pass
        
        return findings, raw_data
