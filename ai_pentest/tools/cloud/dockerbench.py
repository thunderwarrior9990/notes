"""
Docker Bench Security Scanner Wrapper
=====================================

Docker CIS Benchmark tool.
"""

import re
from typing import Dict, List, Any, Tuple, Optional
from ..base import ToolWrapper


class DockerBenchScanner(ToolWrapper):
    TOOL_NAME = "Docker Bench Security"
    BINARY_NAME = "docker-bench-security"
    INSTALL_HINT = "Install from: https://github.com/docker/docker-bench-security"
    
    def build_command(
        self,
        target: str = "",
        log_level: str = "INFO",
        include: Optional[List[str]] = None,
        exclude: Optional[List[str]] = None,
        **kwargs
    ) -> List[str]:
        cmd = [self.BINARY_NAME]
        
        cmd.extend(["-l", log_level])
        
        if include:
            cmd.extend(["-c", ",".join(include)])
        
        if exclude:
            cmd.extend(["-e", ",".join(exclude)])
        
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        findings = []
        raw_data = {"checks": [], "summary": {"pass": 0, "warn": 0, "info": 0, "note": 0}}
        
        check_pattern = r"\[(PASS|WARN|INFO|NOTE)\]\s+([\d.]+)\s+-\s+(.+)"
        for match in re.finditer(check_pattern, output):
            status = match.group(1)
            check_id = match.group(2)
            description = match.group(3)
            
            check = {"status": status, "id": check_id, "description": description}
            raw_data["checks"].append(check)
            
            if status == "PASS":
                raw_data["summary"]["pass"] += 1
            elif status == "WARN":
                raw_data["summary"]["warn"] += 1
                findings.append(self._create_finding(
                    title=f"Docker CIS {check_id}",
                    severity="medium",
                    description=description,
                    check_id=check_id
                ))
            elif status == "INFO":
                raw_data["summary"]["info"] += 1
            elif status == "NOTE":
                raw_data["summary"]["note"] += 1
        
        return findings, raw_data
