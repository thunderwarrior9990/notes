"""
Kube-bench Scanner Wrapper
==========================

CIS Kubernetes Benchmark tool.
"""

import json
from typing import Dict, List, Any, Tuple, Optional
from ..base import ToolWrapper


class KubeBenchScanner(ToolWrapper):
    TOOL_NAME = "Kube-bench"
    BINARY_NAME = "kube-bench"
    INSTALL_HINT = "Install from: https://github.com/aquasecurity/kube-bench"
    
    def build_command(
        self,
        target: str = "all",  # master, node, etcd, policies, all
        benchmark: Optional[str] = None,
        version: Optional[str] = None,
        **kwargs
    ) -> List[str]:
        cmd = [self.BINARY_NAME, "run"]
        
        if target != "all":
            cmd.extend(["--targets", target])
        
        if benchmark:
            cmd.extend(["--benchmark", benchmark])
        
        if version:
            cmd.extend(["--version", version])
        
        cmd.append("--json")
        
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        findings = []
        raw_data = {"controls": [], "summary": {"pass": 0, "fail": 0, "warn": 0}}
        
        try:
            data = json.loads(output)
            
            for control in data.get("Controls", []):
                raw_data["controls"].append(control)
                
                for test in control.get("tests", []):
                    for result in test.get("results", []):
                        status = result.get("status", "")
                        
                        if status == "PASS":
                            raw_data["summary"]["pass"] += 1
                        elif status == "FAIL":
                            raw_data["summary"]["fail"] += 1
                            findings.append(self._create_finding(
                                title=f"CIS {result.get('test_number', '')}: {result.get('test_desc', '')}",
                                severity="medium",
                                description=result.get("test_desc", ""),
                                remediation=result.get("remediation", ""),
                                check_id=result.get("test_number", "")
                            ))
                        elif status == "WARN":
                            raw_data["summary"]["warn"] += 1
                            findings.append(self._create_finding(
                                title=f"CIS Warning: {result.get('test_desc', '')}",
                                severity="low",
                                description=result.get("test_desc", ""),
                                check_id=result.get("test_number", "")
                            ))
        except json.JSONDecodeError:
            pass
        
        return findings, raw_data
