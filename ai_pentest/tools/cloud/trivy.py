"""
Trivy Scanner Wrapper
=====================

Container and infrastructure vulnerability scanner.
"""

import json
from typing import Dict, List, Any, Tuple, Optional
from ..base import ToolWrapper


class TrivyScanner(ToolWrapper):
    """
    Trivy - Vulnerability Scanner
    
    Features:
    - Container image scanning
    - Filesystem scanning
    - Git repository scanning
    - Kubernetes scanning
    - IaC scanning
    """
    
    TOOL_NAME = "Trivy"
    BINARY_NAME = "trivy"
    INSTALL_HINT = "Install with: apt install trivy / brew install trivy"
    
    def build_command(
        self,
        target: str,
        scan_type: str = "image",  # image, fs, repo, k8s, config
        severity: str = "UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL",
        ignore_unfixed: bool = False,
        vuln_type: str = "os,library",
        scanners: str = "vuln,secret,config",
        **kwargs
    ) -> List[str]:
        cmd = [self.BINARY_NAME]
        
        if scan_type == "image":
            cmd.append("image")
        elif scan_type == "fs":
            cmd.append("fs")
        elif scan_type == "repo":
            cmd.append("repo")
        elif scan_type == "k8s":
            cmd.append("k8s")
        elif scan_type == "config":
            cmd.append("config")
        
        cmd.extend(["--severity", severity])
        cmd.extend(["--vuln-type", vuln_type])
        cmd.extend(["--scanners", scanners])
        
        if ignore_unfixed:
            cmd.append("--ignore-unfixed")
        
        output_file = self.output_dir / f"trivy_{target.replace('/', '_').replace(':', '_')}.json"
        cmd.extend(["-f", "json", "-o", str(output_file)])
        
        cmd.append(target)
        
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        findings = []
        raw_data = {"vulnerabilities": [], "secrets": [], "misconfigs": [], "summary": {}}
        
        json_files = list(self.output_dir.glob("trivy_*.json"))
        if json_files:
            try:
                with open(json_files[-1]) as f:
                    data = json.load(f)
                    
                    for result in data.get("Results", []):
                        target = result.get("Target", "")
                        
                        # Vulnerabilities
                        for vuln in result.get("Vulnerabilities", []):
                            raw_data["vulnerabilities"].append(vuln)
                            
                            findings.append(self._create_finding(
                                title=f"{vuln.get('VulnerabilityID', '')}: {vuln.get('PkgName', '')}",
                                severity=vuln.get("Severity", "UNKNOWN").lower(),
                                description=vuln.get("Description", "")[:300],
                                evidence=f"Package: {vuln.get('PkgName')} {vuln.get('InstalledVersion', '')}",
                                remediation=f"Update to {vuln.get('FixedVersion', 'latest')}",
                                cve_id=vuln.get("VulnerabilityID", ""),
                                cvss_score=vuln.get("CVSS", {}).get("nvd", {}).get("V3Score", 0)
                            ))
                        
                        # Secrets
                        for secret in result.get("Secrets", []):
                            raw_data["secrets"].append(secret)
                            
                            findings.append(self._create_finding(
                                title=f"Secret Found: {secret.get('Title', '')}",
                                severity="critical",
                                description=f"Rule: {secret.get('RuleID', '')}",
                                evidence=f"File: {target}",
                                remediation="Remove or rotate the exposed secret"
                            ))
                        
                        # Misconfigurations
                        for misconfig in result.get("Misconfigurations", []):
                            raw_data["misconfigs"].append(misconfig)
                            
                            findings.append(self._create_finding(
                                title=misconfig.get("Title", ""),
                                severity=misconfig.get("Severity", "UNKNOWN").lower(),
                                description=misconfig.get("Description", ""),
                                remediation=misconfig.get("Resolution", ""),
                                check_id=misconfig.get("ID", "")
                            ))
                            
            except Exception:
                pass
        
        return findings, raw_data
