"""
Prowler Scanner Wrapper
=======================

AWS/Azure/GCP security assessment tool.
"""

import json
from typing import Dict, List, Any, Tuple, Optional
from ..base import ToolWrapper


class ProwlerScanner(ToolWrapper):
    TOOL_NAME = "Prowler"
    BINARY_NAME = "prowler"
    INSTALL_HINT = "Install with: pip install prowler"
    
    def build_command(
        self,
        target: str = "aws",  # aws, azure, gcp
        checks: Optional[List[str]] = None,
        categories: Optional[List[str]] = None,
        severity: Optional[str] = None,
        compliance: Optional[str] = None,
        quick: bool = False,
        **kwargs
    ) -> List[str]:
        cmd = [self.BINARY_NAME, target]
        
        if checks:
            cmd.extend(["-c", ",".join(checks)])
        
        if categories:
            cmd.extend(["--categories", ",".join(categories)])
        
        if severity:
            cmd.extend(["--severity", severity])
        
        if compliance:
            cmd.extend(["--compliance", compliance])
        
        if quick:
            cmd.append("-q")
        
        output_dir = self.output_dir / "prowler_output"
        cmd.extend(["-M", "json", "-o", str(output_dir)])
        
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        findings = []
        raw_data = {"checks": [], "summary": {"passed": 0, "failed": 0, "muted": 0}}
        
        json_files = list((self.output_dir / "prowler_output").glob("*.json"))
        if json_files:
            try:
                with open(json_files[-1]) as f:
                    for line in f:
                        try:
                            check = json.loads(line.strip())
                            raw_data["checks"].append(check)
                            
                            if check.get("Status") == "FAIL":
                                raw_data["summary"]["failed"] += 1
                                findings.append(self._create_finding(
                                    title=check.get("CheckTitle", ""),
                                    severity=check.get("Severity", "info").lower(),
                                    description=check.get("Description", ""),
                                    remediation=check.get("Remediation", {}).get("Recommendation", ""),
                                    resource=check.get("ResourceArn", ""),
                                    check_id=check.get("CheckID", "")
                                ))
                            else:
                                raw_data["summary"]["passed"] += 1
                        except json.JSONDecodeError:
                            continue
            except Exception:
                pass
        
        return findings, raw_data
