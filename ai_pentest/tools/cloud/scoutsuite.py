"""
Scout Suite Scanner Wrapper
===========================

Multi-cloud security auditing tool.
"""

import json
from pathlib import Path
from typing import Dict, List, Any, Tuple, Optional
from ..base import ToolWrapper


class ScoutSuiteScanner(ToolWrapper):
    TOOL_NAME = "Scout Suite"
    BINARY_NAME = "scout"
    INSTALL_HINT = "Install with: pip install scoutsuite"
    
    def build_command(
        self,
        target: str = "aws",  # aws, azure, gcp, alibaba, oci
        profile: Optional[str] = None,
        regions: Optional[List[str]] = None,
        services: Optional[List[str]] = None,
        max_workers: int = 10,
        **kwargs
    ) -> List[str]:
        cmd = [self.BINARY_NAME, target]
        
        if profile:
            cmd.extend(["--profile", profile])
        
        if regions:
            cmd.extend(["--regions", ",".join(regions)])
        
        if services:
            cmd.extend(["--services", ",".join(services)])
        
        cmd.extend(["--max-workers", str(max_workers)])
        
        report_dir = self.output_dir / "scoutsuite-report"
        cmd.extend(["--report-dir", str(report_dir)])
        cmd.append("--no-browser")
        
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        findings = []
        raw_data = {"services": {}, "summary": {}}
        
        # Look for scoutsuite-results JSON file
        report_dirs = list(self.output_dir.glob("scoutsuite-report/*"))
        for report_dir in report_dirs:
            results_file = report_dir / "scoutsuite-results" / "scoutsuite_results*.json"
            json_files = list(report_dir.glob("**/*.json"))
            
            for json_file in json_files:
                if "results" in json_file.name:
                    try:
                        with open(json_file) as f:
                            data = json.load(f)
                            
                            for service, service_data in data.get("services", {}).items():
                                raw_data["services"][service] = service_data.get("findings", {})
                                
                                for finding_type, finding_data in service_data.get("findings", {}).items():
                                    if finding_data.get("flagged_items", 0) > 0:
                                        level = finding_data.get("level", "warning")
                                        severity = "high" if level == "danger" else "medium" if level == "warning" else "low"
                                        
                                        findings.append(self._create_finding(
                                            title=finding_data.get("description", finding_type),
                                            severity=severity,
                                            description=f"Flagged items: {finding_data.get('flagged_items', 0)}",
                                            service=service,
                                            remediation=finding_data.get("rationale", "")
                                        ))
                    except Exception:
                        continue
        
        return findings, raw_data
