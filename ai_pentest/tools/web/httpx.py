"""
Httpx Scanner Wrapper
=====================

Fast HTTP toolkit.
"""

import json
from typing import Dict, List, Any, Tuple, Optional

from ..base import ToolWrapper


class HttpxScanner(ToolWrapper):
    """
    Httpx - HTTP probing toolkit
    
    Features:
    - HTTP probing
    - Title extraction
    - Status code detection
    - Technology detection
    - Screenshot capture
    """
    
    TOOL_NAME = "Httpx"
    BINARY_NAME = "httpx"
    INSTALL_HINT = "Install with: go install github.com/projectdiscovery/httpx/cmd/httpx@latest"
    
    INSTALL_COMMANDS = {
        "apt": "sudo apt-get install -y httpx-toolkit || GO111MODULE=on go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest",
        "go": "GO111MODULE=on go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest",
        "brew": "brew install httpx",
    }
    
    REQUIRES_NETWORK = True
    OFFLINE_CAPABLE = False
    
    def build_command(
        self,
        target: str,
        threads: int = 50,
        timeout: int = 10,
        retries: int = 2,
        title: bool = True,
        status_code: bool = True,
        content_length: bool = True,
        tech_detect: bool = True,
        web_server: bool = True,
        ip: bool = True,
        cname: bool = False,
        cdn: bool = True,
        follow_redirects: bool = True,
        screenshot: bool = False,
        ports: Optional[str] = None,
        path: Optional[str] = None,
        match_codes: Optional[str] = None,
        filter_codes: Optional[str] = None,
        **kwargs
    ) -> List[str]:
        cmd = [self.BINARY_NAME]
        
        # Input - can be URL or file
        if target.startswith("http"):
            cmd.extend(["-u", target])
        else:
            cmd.extend(["-target", target])
        
        cmd.extend(["-threads", str(threads)])
        cmd.extend(["-timeout", str(timeout)])
        cmd.extend(["-retries", str(retries)])
        
        if title:
            cmd.append("-title")
        if status_code:
            cmd.append("-status-code")
        if content_length:
            cmd.append("-content-length")
        if tech_detect:
            cmd.append("-tech-detect")
        if web_server:
            cmd.append("-web-server")
        if ip:
            cmd.append("-ip")
        if cname:
            cmd.append("-cname")
        if cdn:
            cmd.append("-cdn")
        if follow_redirects:
            cmd.append("-follow-redirects")
        if screenshot:
            cmd.append("-screenshot")
        
        if ports:
            cmd.extend(["-ports", ports])
        if path:
            cmd.extend(["-path", path])
        if match_codes:
            cmd.extend(["-mc", match_codes])
        if filter_codes:
            cmd.extend(["-fc", filter_codes])
        
        output_file = self.output_dir / f"httpx_{target.replace('://', '_').replace('/', '_')}.json"
        cmd.extend(["-json", "-o", str(output_file)])
        
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        findings = []
        raw_data = {"hosts": [], "technologies": [], "cdn_detected": []}
        
        json_files = list(self.output_dir.glob("httpx_*.json"))
        if json_files:
            try:
                with open(json_files[-1]) as f:
                    for line in f:
                        try:
                            entry = json.loads(line.strip())
                            host_data = {
                                "url": entry.get("url", ""),
                                "status_code": entry.get("status_code", 0),
                                "title": entry.get("title", ""),
                                "webserver": entry.get("webserver", ""),
                                "technologies": entry.get("tech", []),
                                "content_length": entry.get("content_length", 0),
                                "host": entry.get("host", ""),
                                "ip": entry.get("a", []),
                                "cdn": entry.get("cdn", False)
                            }
                            raw_data["hosts"].append(host_data)
                            
                            if host_data["technologies"]:
                                raw_data["technologies"].extend(host_data["technologies"])
                            
                            if host_data["cdn"]:
                                raw_data["cdn_detected"].append(host_data["url"])
                            
                            findings.append(self._create_finding(
                                title=f"HTTP Host: {host_data['url']}",
                                severity="info",
                                description=f"Title: {host_data['title']}\n"
                                           f"Server: {host_data['webserver']}\n"
                                           f"Tech: {', '.join(host_data['technologies'])}",
                                url=host_data["url"],
                                status_code=host_data["status_code"]
                            ))
                        except json.JSONDecodeError:
                            continue
            except Exception:
                pass
        
        return findings, raw_data
