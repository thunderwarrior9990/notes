"""
Dalfox Scanner Wrapper
======================

XSS scanning and parameter analysis tool.
"""

import json
from typing import Dict, List, Any, Tuple, Optional

from ..base import ToolWrapper


class DalfoxScanner(ToolWrapper):
    """
    Dalfox - XSS Scanner
    
    Features:
    - Reflected XSS detection
    - Stored XSS detection
    - DOM XSS detection
    - WAF detection and bypass
    """
    
    TOOL_NAME = "Dalfox"
    BINARY_NAME = "dalfox"
    INSTALL_HINT = "Install with: go install github.com/hahwul/dalfox/v2@latest"
    
    def build_command(
        self,
        target: str,
        data: Optional[str] = None,
        cookie: Optional[str] = None,
        headers: Optional[Dict[str, str]] = None,
        param: Optional[str] = None,
        blind: Optional[str] = None,
        mining_dict: bool = True,
        mining_dom: bool = True,
        deep_domxss: bool = False,
        follow_redirects: bool = True,
        waf_evasion: bool = False,
        skip_bav: bool = False,
        silence: bool = False,
        **kwargs
    ) -> List[str]:
        cmd = [self.BINARY_NAME, "url", target]
        
        if data:
            cmd.extend(["--data", data])
        
        if cookie:
            cmd.extend(["--cookie", cookie])
        
        if headers:
            for key, value in headers.items():
                cmd.extend(["--header", f"{key}: {value}"])
        
        if param:
            cmd.extend(["--param", param])
        
        if blind:
            cmd.extend(["--blind", blind])
        
        if mining_dict:
            cmd.append("--mining-dict")
        
        if mining_dom:
            cmd.append("--mining-dom")
        
        if deep_domxss:
            cmd.append("--deep-domxss")
        
        if follow_redirects:
            cmd.append("--follow-redirects")
        
        if waf_evasion:
            cmd.append("--waf-evasion")
        
        if skip_bav:
            cmd.append("--skip-bav")
        
        if silence:
            cmd.append("-S")
        
        output_file = self.output_dir / f"dalfox_{target.replace('://', '_').replace('/', '_')}.json"
        cmd.extend(["--format", "json", "-o", str(output_file)])
        
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        findings = []
        raw_data = {"vulnerabilities": [], "params_tested": [], "waf_detected": False}
        
        json_files = list(self.output_dir.glob("dalfox_*.json"))
        if json_files:
            try:
                with open(json_files[-1]) as f:
                    data = json.load(f)
                    
                    for result in data if isinstance(data, list) else [data]:
                        if result.get("type") == "vuln":
                            vuln = {
                                "url": result.get("data", ""),
                                "param": result.get("param", ""),
                                "payload": result.get("payload", ""),
                                "type": result.get("message_type", "")
                            }
                            raw_data["vulnerabilities"].append(vuln)
                            
                            findings.append(self._create_finding(
                                title=f"XSS Vulnerability: {vuln['param']}",
                                severity="high",
                                description=f"Type: {vuln['type']}",
                                evidence=f"Payload: {vuln['payload']}",
                                url=vuln["url"],
                                parameter=vuln["param"],
                                cwe_id="CWE-79",
                                remediation="Encode output and validate input"
                            ))
            except Exception:
                pass
        
        # Check for WAF in output
        if "WAF" in output:
            raw_data["waf_detected"] = True
            findings.append(self._create_finding(
                title="WAF Detected",
                severity="info",
                description="Web Application Firewall detected"
            ))
        
        return findings, raw_data
