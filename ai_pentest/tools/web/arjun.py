"""
Arjun Scanner Wrapper
=====================

HTTP parameter discovery suite.
"""

import json
from typing import Dict, List, Any, Tuple, Optional

from ..base import ToolWrapper


class ArjunScanner(ToolWrapper):
    """
    Arjun - Parameter Discovery
    
    Features:
    - GET/POST parameter discovery
    - JSON parameter discovery
    - Header injection points
    """
    
    TOOL_NAME = "Arjun"
    BINARY_NAME = "arjun"
    INSTALL_HINT = "Install with: pip install arjun"
    
    def build_command(
        self,
        target: str,
        method: str = "GET",
        headers: Optional[Dict[str, str]] = None,
        threads: int = 5,
        delay: int = 0,
        include: Optional[str] = None,
        stable: bool = False,
        **kwargs
    ) -> List[str]:
        cmd = [self.BINARY_NAME]
        
        cmd.extend(["-u", target])
        cmd.extend(["-m", method])
        cmd.extend(["-t", str(threads)])
        
        if delay > 0:
            cmd.extend(["-d", str(delay)])
        
        if headers:
            for key, value in headers.items():
                cmd.extend(["--headers", f"{key}: {value}"])
        
        if include:
            cmd.extend(["--include", include])
        
        if stable:
            cmd.append("--stable")
        
        output_file = self.output_dir / f"arjun_{target.replace('://', '_').replace('/', '_')}.json"
        cmd.extend(["-oJ", str(output_file)])
        
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        findings = []
        raw_data = {"parameters": [], "endpoints": []}
        
        json_files = list(self.output_dir.glob("arjun_*.json"))
        if json_files:
            try:
                with open(json_files[-1]) as f:
                    data = json.load(f)
                    
                    for url, params in data.items():
                        endpoint = {"url": url, "parameters": params}
                        raw_data["endpoints"].append(endpoint)
                        raw_data["parameters"].extend(params)
                        
                        for param in params:
                            findings.append(self._create_finding(
                                title=f"Parameter Found: {param}",
                                severity="info",
                                description=f"Hidden parameter discovered at {url}",
                                url=url,
                                parameter=param
                            ))
            except Exception:
                pass
        
        return findings, raw_data
