"""
Nikto Scanner Wrapper
=====================

Web server scanner.
"""

import re
import json
from typing import Dict, List, Any, Tuple, Optional

from ..base import ToolWrapper


class NiktoScanner(ToolWrapper):
    """
    Nikto - Web server scanner
    
    Features:
    - Server misconfigurations
    - Dangerous files
    - Outdated software
    - Known vulnerabilities
    """
    
    TOOL_NAME = "Nikto"
    BINARY_NAME = "nikto"
    INSTALL_HINT = "Install with: apt install nikto"
    
    def build_command(
        self,
        target: str,
        port: Optional[int] = None,
        ssl: bool = False,
        plugins: Optional[str] = None,
        tuning: Optional[str] = None,
        evasion: Optional[str] = None,
        timeout: int = 10,
        pause: int = 0,
        no_404: bool = False,
        **kwargs
    ) -> List[str]:
        cmd = [self.BINARY_NAME]
        
        cmd.extend(["-h", target])
        
        if port:
            cmd.extend(["-p", str(port)])
        
        if ssl:
            cmd.append("-ssl")
        
        if plugins:
            cmd.extend(["-Plugins", plugins])
        
        if tuning:
            cmd.extend(["-Tuning", tuning])
        
        if evasion:
            cmd.extend(["-evasion", evasion])
        
        cmd.extend(["-timeout", str(timeout)])
        
        if pause > 0:
            cmd.extend(["-Pause", str(pause)])
        
        if no_404:
            cmd.append("-no404")
        
        output_file = self.output_dir / f"nikto_{target.replace('://', '_').replace('/', '_')}"
        cmd.extend(["-o", str(output_file) + ".json", "-Format", "json"])
        
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        findings = []
        raw_data = {"vulnerabilities": [], "server_info": {}, "items": []}
        
        # Try JSON output
        json_files = list(self.output_dir.glob("nikto_*.json"))
        if json_files:
            try:
                with open(json_files[-1]) as f:
                    data = json.load(f)
                    
                    for host in data.get("host", []):
                        raw_data["server_info"] = {
                            "ip": host.get("ip", ""),
                            "hostname": host.get("hostname", ""),
                            "port": host.get("port", ""),
                            "banner": host.get("banner", "")
                        }
                        
                        for item in host.get("items", []):
                            vuln = {
                                "id": item.get("id", ""),
                                "osvdb": item.get("OSVDB", ""),
                                "method": item.get("method", ""),
                                "uri": item.get("uri", ""),
                                "description": item.get("description", "")
                            }
                            raw_data["items"].append(vuln)
                            
                            # Determine severity
                            severity = "info"
                            desc_lower = vuln["description"].lower()
                            if any(x in desc_lower for x in ["remote code", "rce", "sql injection", "command injection"]):
                                severity = "critical"
                            elif any(x in desc_lower for x in ["xss", "sensitive", "password", "credential"]):
                                severity = "high"
                            elif any(x in desc_lower for x in ["disclosure", "directory listing", "version"]):
                                severity = "medium"
                            elif any(x in desc_lower for x in ["outdated", "deprecated"]):
                                severity = "low"
                            
                            findings.append(self._create_finding(
                                title=f"Nikto: {vuln['description'][:60]}...",
                                severity=severity,
                                description=vuln["description"],
                                evidence=f"URI: {vuln['uri']}",
                                url=vuln["uri"],
                                osvdb=vuln["osvdb"]
                            ))
            except Exception:
                pass
        
        # Fallback to text parsing
        if not raw_data["items"]:
            vuln_pattern = r"\+\s+(.+?):\s+(.+)"
            for match in re.finditer(vuln_pattern, output):
                findings.append(self._create_finding(
                    title=f"Nikto Finding: {match.group(1)}",
                    severity="info",
                    description=match.group(2)
                ))
        
        return findings, raw_data
