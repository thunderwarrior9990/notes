"""
Ffuf Scanner Wrapper
====================

Fast web fuzzer.
"""

import json
from typing import Dict, List, Any, Tuple, Optional

from ..base import ToolWrapper


class FfufScanner(ToolWrapper):
    """
    Ffuf - Fast web fuzzer
    
    Features:
    - Directory/file fuzzing
    - Parameter fuzzing
    - Header fuzzing
    - Virtual host discovery
    """
    
    TOOL_NAME = "Ffuf"
    BINARY_NAME = "ffuf"
    INSTALL_HINT = "Install with: go install github.com/ffuf/ffuf/v2@latest"
    
    INSTALL_COMMANDS = {
        "apt": "sudo apt-get install -y ffuf || GO111MODULE=on go install github.com/ffuf/ffuf/v2@latest",
        "go": "GO111MODULE=on go install github.com/ffuf/ffuf/v2@latest",
        "brew": "brew install ffuf",
    }
    
    REQUIRES_NETWORK = True
    OFFLINE_CAPABLE = False
    
    def build_command(
        self,
        target: str,
        wordlist: str = "/usr/share/seclists/Discovery/Web-Content/common.txt",
        method: str = "GET",
        data: Optional[str] = None,
        headers: Optional[Dict[str, str]] = None,
        cookies: Optional[str] = None,
        threads: int = 40,
        rate: int = 0,
        timeout: int = 10,
        match_codes: Optional[str] = None,
        filter_codes: Optional[str] = None,
        filter_size: Optional[str] = None,
        filter_words: Optional[str] = None,
        recursion: bool = False,
        recursion_depth: int = 2,
        extensions: Optional[str] = None,
        **kwargs
    ) -> List[str]:
        cmd = [self.BINARY_NAME]
        
        # URL with FUZZ keyword
        if "FUZZ" not in target:
            target = target.rstrip("/") + "/FUZZ"
        
        cmd.extend(["-u", target])
        cmd.extend(["-w", wordlist])
        cmd.extend(["-X", method])
        cmd.extend(["-t", str(threads)])
        cmd.extend(["-timeout", str(timeout)])
        
        if data:
            cmd.extend(["-d", data])
        
        if headers:
            for key, value in headers.items():
                cmd.extend(["-H", f"{key}: {value}"])
        
        if cookies:
            cmd.extend(["-b", cookies])
        
        if rate > 0:
            cmd.extend(["-rate", str(rate)])
        
        if match_codes:
            cmd.extend(["-mc", match_codes])
        
        if filter_codes:
            cmd.extend(["-fc", filter_codes])
        
        if filter_size:
            cmd.extend(["-fs", filter_size])
        
        if filter_words:
            cmd.extend(["-fw", filter_words])
        
        if recursion:
            cmd.append("-recursion")
            cmd.extend(["-recursion-depth", str(recursion_depth)])
        
        if extensions:
            cmd.extend(["-e", extensions])
        
        output_file = self.output_dir / f"ffuf_{target.replace('://', '_').replace('/', '_').replace('FUZZ', 'result')}.json"
        cmd.extend(["-o", str(output_file), "-of", "json"])
        
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        findings = []
        raw_data = {"results": [], "config": {}}
        
        json_files = list(self.output_dir.glob("ffuf_*.json"))
        if json_files:
            try:
                with open(json_files[-1]) as f:
                    data = json.load(f)
                    raw_data["config"] = data.get("config", {})
                    
                    for result in data.get("results", []):
                        result_data = {
                            "input": result.get("input", {}).get("FUZZ", ""),
                            "url": result.get("url", ""),
                            "status": result.get("status", 0),
                            "length": result.get("length", 0),
                            "words": result.get("words", 0),
                            "lines": result.get("lines", 0)
                        }
                        raw_data["results"].append(result_data)
                        
                        severity = "info"
                        if any(x in result_data["input"].lower() for x in ["admin", "backup", "config"]):
                            severity = "medium"
                        
                        findings.append(self._create_finding(
                            title=f"Found: {result_data['input']}",
                            severity=severity,
                            description=f"Status: {result_data['status']}, Length: {result_data['length']}",
                            url=result_data["url"],
                            status_code=result_data["status"]
                        ))
            except Exception:
                pass
        
        return findings, raw_data
