"""
Dirsearch Scanner Wrapper
=========================

Web path discovery tool.
"""

import json
import re
from typing import Dict, List, Any, Tuple, Optional

from ..base import ToolWrapper


class DirsearchScanner(ToolWrapper):
    TOOL_NAME = "Dirsearch"
    BINARY_NAME = "dirsearch"
    INSTALL_HINT = "Install with: pip install dirsearch"
    
    INSTALL_COMMANDS = {
        "pip": "pip install dirsearch",
        "apt": "sudo apt-get install -y dirsearch || pip install dirsearch",
    }
    
    REQUIRES_NETWORK = True
    OFFLINE_CAPABLE = False
    
    def build_command(
        self,
        target: str,
        wordlist: Optional[str] = None,
        extensions: Optional[List[str]] = None,
        threads: int = 30,
        recursive: bool = True,
        recursion_depth: int = 3,
        exclude_status: Optional[List[int]] = None,
        follow_redirects: bool = False,
        random_agent: bool = True,
        **kwargs
    ) -> List[str]:
        cmd = [self.BINARY_NAME]
        
        cmd.extend(["-u", target])
        
        if wordlist:
            cmd.extend(["-w", wordlist])
        
        if extensions:
            cmd.extend(["-e", ",".join(extensions)])
        
        cmd.extend(["-t", str(threads)])
        
        if recursive:
            cmd.append("-r")
            cmd.extend(["-R", str(recursion_depth)])
        
        if exclude_status:
            cmd.extend(["-x", ",".join(map(str, exclude_status))])
        
        if follow_redirects:
            cmd.append("-F")
        
        if random_agent:
            cmd.append("--random-agent")
        
        output_file = self.output_dir / f"dirsearch_{target.replace('://', '_').replace('/', '_')}"
        cmd.extend(["-o", str(output_file), "--format", "json"])
        
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        findings = []
        raw_data = {"results": []}
        
        # Parse JSON output
        json_files = list(self.output_dir.glob("dirsearch_*"))
        for json_file in json_files:
            try:
                with open(json_file) as f:
                    data = json.load(f)
                    for url, results in data.get("results", {}).items():
                        for result in results:
                            raw_data["results"].append(result)
                            
                            findings.append(self._create_finding(
                                title=f"Found: {result.get('path', '')}",
                                severity="info",
                                description=f"Status: {result.get('status')}, Size: {result.get('content-length', 0)}",
                                url=result.get("url", ""),
                                status_code=result.get("status")
                            ))
            except Exception:
                continue
        
        return findings, raw_data
