"""
Wafw00f Scanner Wrapper
=======================

Web Application Firewall detection tool.
"""

import json
import re
from typing import Dict, List, Any, Tuple, Optional

from ..base import ToolWrapper


class Wafw00fScanner(ToolWrapper):
    """
    Wafw00f - WAF Detection
    
    Features:
    - WAF fingerprinting
    - Multiple WAF detection
    - Generic WAF detection
    """
    
    TOOL_NAME = "Wafw00f"
    BINARY_NAME = "wafw00f"
    INSTALL_HINT = "Install with: pip install wafw00f"
    
    def build_command(
        self,
        target: str,
        list_wafs: bool = False,
        find_all: bool = True,
        verbose: bool = False,
        **kwargs
    ) -> List[str]:
        cmd = [self.BINARY_NAME]
        
        if list_wafs:
            cmd.append("-l")
        else:
            cmd.append(target)
            
            if find_all:
                cmd.append("-a")
            
            if verbose:
                cmd.append("-v")
            
            output_file = self.output_dir / f"wafw00f_{target.replace('://', '_').replace('/', '_')}.json"
            cmd.extend(["-o", str(output_file), "-f", "json"])
        
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        findings = []
        raw_data = {"wafs_detected": [], "target": "", "generic_waf": False}
        
        json_files = list(self.output_dir.glob("wafw00f_*.json"))
        if json_files:
            try:
                with open(json_files[-1]) as f:
                    data = json.load(f)
                    
                    for entry in data if isinstance(data, list) else [data]:
                        raw_data["target"] = entry.get("url", "")
                        detected = entry.get("detected", [])
                        
                        if detected:
                            raw_data["wafs_detected"] = detected
                            
                            for waf in detected:
                                findings.append(self._create_finding(
                                    title=f"WAF Detected: {waf}",
                                    severity="info",
                                    description=f"Web Application Firewall identified: {waf}",
                                    waf=waf,
                                    remediation="Consider WAF bypass techniques during testing"
                                ))
                        
                        if entry.get("firewall") == "Generic":
                            raw_data["generic_waf"] = True
                            findings.append(self._create_finding(
                                title="Generic WAF Detected",
                                severity="info",
                                description="A generic WAF/security solution is present"
                            ))
            except Exception:
                pass
        
        # Fallback to text parsing
        if not raw_data["wafs_detected"]:
            waf_pattern = r"is behind\s+(.+)"
            for match in re.finditer(waf_pattern, output):
                waf = match.group(1).strip()
                raw_data["wafs_detected"].append(waf)
                findings.append(self._create_finding(
                    title=f"WAF Detected: {waf}",
                    severity="info",
                    description=f"Web Application Firewall: {waf}"
                ))
            
            if "No WAF" in output:
                findings.append(self._create_finding(
                    title="No WAF Detected",
                    severity="info",
                    description="No Web Application Firewall was detected"
                ))
        
        return findings, raw_data
