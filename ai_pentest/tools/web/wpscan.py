"""
WPScan Scanner Wrapper
======================

WordPress security scanner.
"""

import json
from typing import Dict, List, Any, Tuple, Optional

from ..base import ToolWrapper


class WpscanScanner(ToolWrapper):
    """
    WPScan - WordPress Security Scanner
    
    Features:
    - Plugin enumeration
    - Theme enumeration
    - User enumeration
    - Vulnerability detection
    """
    
    TOOL_NAME = "WPScan"
    BINARY_NAME = "wpscan"
    INSTALL_HINT = "Install with: gem install wpscan / apt install wpscan"
    
    def build_command(
        self,
        target: str,
        enumerate: Optional[str] = None,
        plugins_detection: str = "mixed",
        api_token: Optional[str] = None,
        random_agent: bool = True,
        force: bool = False,
        disable_tls_checks: bool = False,
        password_attack: bool = False,
        usernames: Optional[str] = None,
        passwords: Optional[str] = None,
        **kwargs
    ) -> List[str]:
        cmd = [self.BINARY_NAME]
        
        cmd.extend(["--url", target])
        
        if enumerate:
            cmd.extend(["-e", enumerate])
        else:
            cmd.extend(["-e", "vp,vt,u"])  # Vulnerable plugins, themes, users
        
        cmd.extend(["--plugins-detection", plugins_detection])
        
        if api_token:
            cmd.extend(["--api-token", api_token])
        
        if random_agent:
            cmd.append("--random-user-agent")
        
        if force:
            cmd.append("--force")
        
        if disable_tls_checks:
            cmd.append("--disable-tls-checks")
        
        if password_attack and usernames and passwords:
            cmd.extend(["-U", usernames, "-P", passwords])
        
        output_file = self.output_dir / f"wpscan_{target.replace('://', '_').replace('/', '_')}.json"
        cmd.extend(["-f", "json", "-o", str(output_file)])
        
        return cmd
    
    def parse_output(self, output: str, error: str) -> Tuple[List[Dict[str, Any]], Dict[str, Any]]:
        findings = []
        raw_data = {
            "wordpress_version": "",
            "theme": {},
            "plugins": [],
            "users": [],
            "vulnerabilities": []
        }
        
        json_files = list(self.output_dir.glob("wpscan_*.json"))
        if json_files:
            try:
                with open(json_files[-1]) as f:
                    data = json.load(f)
                    
                    # WordPress version
                    version = data.get("version", {})
                    if version:
                        raw_data["wordpress_version"] = version.get("number", "")
                        
                        if version.get("status") == "insecure":
                            findings.append(self._create_finding(
                                title=f"Outdated WordPress: {raw_data['wordpress_version']}",
                                severity="high",
                                description="WordPress version is outdated and vulnerable",
                                remediation="Update WordPress to the latest version"
                            ))
                        
                        for vuln in version.get("vulnerabilities", []):
                            raw_data["vulnerabilities"].append(vuln)
                            findings.append(self._create_finding(
                                title=f"WordPress Vuln: {vuln.get('title', '')}",
                                severity="high",
                                description=vuln.get("title", ""),
                                references=vuln.get("references", {}).get("url", [])
                            ))
                    
                    # Theme
                    theme = data.get("main_theme", {})
                    if theme:
                        raw_data["theme"] = theme
                        for vuln in theme.get("vulnerabilities", []):
                            findings.append(self._create_finding(
                                title=f"Theme Vuln: {vuln.get('title', '')}",
                                severity="high",
                                description=f"Vulnerable theme: {theme.get('slug', '')}"
                            ))
                    
                    # Plugins
                    for plugin_name, plugin_data in data.get("plugins", {}).items():
                        raw_data["plugins"].append({
                            "name": plugin_name,
                            "version": plugin_data.get("version", {}).get("number", ""),
                            "vulnerabilities": plugin_data.get("vulnerabilities", [])
                        })
                        
                        for vuln in plugin_data.get("vulnerabilities", []):
                            findings.append(self._create_finding(
                                title=f"Plugin Vuln: {vuln.get('title', '')}",
                                severity="high",
                                description=f"Vulnerable plugin: {plugin_name}",
                                plugin=plugin_name
                            ))
                    
                    # Users
                    for user in data.get("users", []):
                        raw_data["users"].append(user)
                        findings.append(self._create_finding(
                            title=f"WordPress User: {user}",
                            severity="info",
                            description="User enumerated via WPScan"
                        ))
                        
            except Exception:
                pass
        
        return findings, raw_data
