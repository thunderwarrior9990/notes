"""
AI Prompts for Penetration Testing
===================================

Carefully crafted prompts for various pentest analysis tasks.
"""

from typing import Dict, Any, List, Optional
import json


class PentestPrompts:
    """Collection of prompts for AI-assisted penetration testing"""
    
    # System prompts for different roles
    SECURITY_ANALYST_SYSTEM = """You are an expert security analyst and penetration tester with decades of experience. You specialize in:

- Web application security (OWASP Top 10)
- Network security and infrastructure assessment  
- Vulnerability analysis and exploitation
- Security best practices and remediation

When analyzing security findings:
1. Assess the severity accurately (Critical, High, Medium, Low, Info)
2. Explain the technical impact clearly
3. Provide actionable remediation steps
4. Consider business context and risk
5. Reference relevant standards (CVE, CWE, OWASP)

Always be thorough, precise, and professional. Provide evidence-based analysis."""

    REPORT_WRITER_SYSTEM = """You are a professional security consultant specializing in penetration testing reports. You excel at:

- Writing clear, concise executive summaries for non-technical stakeholders
- Documenting technical findings with proper evidence
- Providing actionable remediation recommendations
- Prioritizing findings by risk and business impact
- Creating professional, well-structured reports

Format your output in clean markdown. Use tables where appropriate. Be precise and professional."""

    RECON_ANALYST_SYSTEM = """You are an expert in reconnaissance and OSINT (Open Source Intelligence) for penetration testing. You specialize in:

- Domain and subdomain enumeration analysis
- Network infrastructure assessment
- Technology stack identification
- Attack surface mapping
- Information gathering techniques

Provide thorough analysis of reconnaissance data to identify potential attack vectors and security concerns."""

    EXPLOIT_ADVISOR_SYSTEM = """You are an ethical hacking advisor specializing in exploitation techniques. You provide:

- Safe, authorized exploitation guidance
- Proof of concept development advice
- Attack chain analysis
- Post-exploitation recommendations

IMPORTANT: All advice is for authorized security testing only. Always emphasize the importance of:
- Proper authorization
- Scope limitations
- Legal compliance
- Responsible disclosure"""

    @staticmethod
    def vulnerability_analysis(
        vuln_type: str,
        evidence: Dict[str, Any],
        target: str
    ) -> str:
        """Generate prompt for vulnerability analysis"""
        return f"""Analyze this potential {vuln_type} vulnerability discovered during a penetration test.

## Target
{target}

## Evidence
```json
{json.dumps(evidence, indent=2)}
```

Please provide:

1. **Severity Assessment** (Critical/High/Medium/Low/Info) with CVSS-like scoring rationale
2. **Technical Analysis** - Explain how this vulnerability works
3. **Potential Impact** - What could an attacker achieve?
4. **Exploitation Scenario** - How could this be exploited?
5. **Remediation Steps** - Specific fixes for this issue
6. **References** - Relevant CWE/CVE/OWASP references

Be thorough and precise in your analysis."""

    @staticmethod
    def report_section(
        section: str,
        findings: List[Dict[str, Any]],
        target_info: Dict[str, Any]
    ) -> str:
        """Generate prompt for report section"""
        section_prompts = {
            "executive_summary": f"""Write an executive summary for a penetration test report.

## Target Information
{json.dumps(target_info, indent=2)}

## Summary of Findings
- Total findings: {len(findings)}
- Critical: {sum(1 for f in findings if f.get('severity') == 'critical')}
- High: {sum(1 for f in findings if f.get('severity') == 'high')}
- Medium: {sum(1 for f in findings if f.get('severity') == 'medium')}
- Low: {sum(1 for f in findings if f.get('severity') == 'low')}
- Informational: {sum(1 for f in findings if f.get('severity') == 'info')}

The executive summary should:
1. Be suitable for C-level executives and non-technical stakeholders
2. Summarize the overall security posture
3. Highlight the most critical risks
4. Provide high-level recommendations
5. Be 2-3 paragraphs maximum

Write in a professional, clear, and concise manner.""",

            "technical_findings": f"""Document the technical findings from this penetration test.

## Findings Data
```json
{json.dumps(findings, indent=2)}
```

For each finding, create a detailed write-up including:
1. Finding title and ID
2. Severity rating with justification
3. Affected components
4. Technical description
5. Steps to reproduce
6. Evidence/proof of concept
7. Remediation recommendations
8. References (CWE, CVE, OWASP)

Format as professional markdown with proper headings and structure.""",

            "recommendations": f"""Create a prioritized remediation roadmap based on these findings.

## Findings
```json
{json.dumps(findings, indent=2)}
```

Provide:
1. **Immediate Actions** (0-7 days) - Critical and easily exploitable issues
2. **Short-term Actions** (1-4 weeks) - High severity issues
3. **Medium-term Actions** (1-3 months) - Medium severity issues
4. **Long-term Improvements** (3-6 months) - Strategic security enhancements

For each recommendation:
- Explain the fix clearly
- Estimate effort level
- Note any dependencies
- Suggest verification methods""",

            "methodology": """Describe the penetration testing methodology used.

Create a professional methodology section covering:
1. **Scope Definition** - What was tested
2. **Reconnaissance** - Information gathering techniques
3. **Vulnerability Assessment** - Scanning and analysis methods
4. **Exploitation** - Testing approach (if applicable)
5. **Post-Exploitation** - Privilege escalation tests (if applicable)
6. **Reporting** - Documentation process
7. **Tools Used** - Security tools employed
8. **Limitations** - Any constraints on testing

Reference industry standards (PTES, OWASP, NIST) where applicable.""",
        }
        
        return section_prompts.get(section, f"Generate the {section} section for a penetration test report based on the provided findings.")

    @staticmethod
    def analyze_scan_results(
        scan_type: str,
        results: Dict[str, Any],
        target: str
    ) -> str:
        """Generate prompt for scan result analysis"""
        return f"""Analyze these {scan_type} scan results from a penetration test.

## Target
{target}

## Scan Results
```json
{json.dumps(results, indent=2)}
```

Provide:
1. **Key Findings Summary** - Most important discoveries
2. **Security Concerns** - Potential vulnerabilities identified
3. **Attack Surface Analysis** - Exposed services and entry points
4. **Recommendations** - Next steps for testing
5. **Risk Assessment** - Overall risk level for this area

Focus on actionable insights for the penetration tester."""

    @staticmethod
    def suggest_exploits(
        vulnerability: Dict[str, Any],
        target_info: Dict[str, Any]
    ) -> str:
        """Generate prompt for exploit suggestions"""
        return f"""As an ethical security researcher, suggest testing approaches for this vulnerability.

## Vulnerability Details
```json
{json.dumps(vulnerability, indent=2)}
```

## Target Context
```json
{json.dumps(target_info, indent=2)}
```

Provide:
1. **Proof of Concept Approach** - Safe way to demonstrate the issue
2. **Testing Steps** - Detailed steps for verification
3. **Tools to Use** - Recommended security tools
4. **Expected Results** - What successful exploitation looks like
5. **Safety Considerations** - How to test safely without causing damage
6. **Documentation Tips** - How to capture evidence

REMINDER: This is for authorized security testing only. All tests must be within scope and properly authorized."""

    @staticmethod
    def analyze_technology_stack(
        technologies: Dict[str, Any],
        target: str
    ) -> str:
        """Generate prompt for technology stack analysis"""
        return f"""Analyze the technology stack discovered for this target.

## Target
{target}

## Detected Technologies
```json
{json.dumps(technologies, indent=2)}
```

Provide:
1. **Technology Overview** - Summary of the stack
2. **Known Vulnerabilities** - Common CVEs for detected versions
3. **Configuration Concerns** - Potential misconfigurations
4. **Attack Vectors** - Likely entry points based on stack
5. **Security Best Practices** - Recommendations for hardening
6. **Further Testing** - Suggested next steps

Focus on security implications of the identified technologies."""

    @staticmethod
    def subdomain_analysis(
        subdomains: List[str],
        domain: str
    ) -> str:
        """Generate prompt for subdomain analysis"""
        return f"""Analyze these discovered subdomains for security testing.

## Primary Domain
{domain}

## Discovered Subdomains
{json.dumps(subdomains, indent=2)}

Provide:
1. **Subdomain Categories** - Group by purpose (dev, staging, api, etc.)
2. **High-Value Targets** - Subdomains most likely to have vulnerabilities
3. **Potential Risks** - Security concerns from naming patterns
4. **Shadow IT Indicators** - Signs of unmanaged infrastructure
5. **Testing Priority** - Recommended order for testing
6. **Attack Surface** - Overall exposure assessment

Identify patterns that suggest security weaknesses."""

    @staticmethod
    def network_analysis(
        open_ports: List[Dict[str, Any]],
        target: str
    ) -> str:
        """Generate prompt for network analysis"""
        return f"""Analyze these network scan results for security assessment.

## Target
{target}

## Open Ports and Services
```json
{json.dumps(open_ports, indent=2)}
```

Provide:
1. **Service Overview** - Summary of exposed services
2. **Critical Services** - High-risk services that need attention
3. **Version Analysis** - Outdated or vulnerable versions
4. **Unnecessary Exposure** - Services that shouldn't be public
5. **Attack Vectors** - Potential exploitation paths
6. **Hardening Recommendations** - How to reduce attack surface

Focus on identifying the most exploitable entry points."""
